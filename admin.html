<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - S Shop LK</title>
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="https://i.ibb.co/FqsbsjVB/S-shop-lk-logo.png">
    <link rel="shortcut icon" type="image/png" href="https://i.ibb.co/FqsbsjVB/S-shop-lk-logo.png">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            color: #334155;
        }
        
        /* Custom slider styling */
        .slider {
            -webkit-appearance: none;
            appearance: none;
            background: #e5e7eb;
            outline: none;
            border-radius: 8px;
            transition: background 0.2s;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #3b82f6;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.2s;
        }
        
        .slider::-webkit-slider-thumb:hover {
            background: #2563eb;
            transform: scale(1.1);
        }
        
        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #3b82f6;
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.2s;
        }
        
        .slider::-moz-range-thumb:hover {
            background: #2563eb;
            transform: scale(1.1);
        }
        
        .slider:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <svg class="h-8 w-8 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                </svg>
                <span class="text-2xl font-extrabold text-gray-900">Products Management</span>
            </div>
            <div class="flex items-center space-x-4">
                <span class="text-sm text-gray-600">Welcome, <span id="adminUsername">Admin</span></span>
                <button onclick="logout()" class="bg-red-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-700 transition-colors">
                    Logout
                </button>
                <a href="index.html" class="text-blue-600 hover:text-blue-800">‚Üê Back to Website</a>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b border-gray-200">
        <div class="container mx-auto px-4">
            <div class="flex space-x-8 py-2">
                <a href="admin-dashboard.html" class="text-gray-500 hover:text-gray-700 py-2 px-1 text-sm font-medium">
                    Dashboard
                </a>
                <a href="admin.html" class="text-blue-600 border-b-2 border-blue-600 py-2 px-1 text-sm font-medium">
                    Products
                </a>
                <a href="admin-orders.html" class="text-gray-500 hover:text-gray-700 py-2 px-1 text-sm font-medium">
                    Orders
                </a>
                <a href="admin-customers.html" class="text-gray-500 hover:text-gray-700 py-2 px-1 text-sm font-medium">
                    Customers
                </a>
                <a href="admin-chat.html" class="text-gray-500 hover:text-gray-700 py-2 px-1 text-sm font-medium">
                    Chat
                </a>
                <a href="admin-logs.html" class="text-gray-500 hover:text-gray-700 py-2 px-1 text-sm font-medium">
                    Logs
                </a>
                <a href="admin-settings.html" class="text-gray-500 hover:text-gray-700 py-2 px-1 text-sm font-medium">
                    Settings
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Left Sidebar - Add/Edit Product Form -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-xl border border-gray-200 p-6">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">Add New Product</h2>
                    
                    <form id="productForm" class="space-y-4">
                        <input type="hidden" id="productId" value="">
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Product Name</label>
                            <input type="text" id="productName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                            <textarea id="productDescription" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required></textarea>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Price (LKR)</label>
                                <input type="number" id="productPrice" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Availability</label>
                                <input type="number" id="productAvailability" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Sold Count</label>
                                <input type="number" id="productSoldCount" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" value="0">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Image URL</label>
                            <input type="url" id="productImage" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                                <select id="productCategory" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                    <option value="">Select Category</option>
                                    <option value="games">Games</option>
                                    <option value="software-apps">Software & Apps</option>
                                    <option value="boosting-coaching">Boosting & Coaching</option>
                                    <option value="gift-cards">Gift Cards</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Subcategory</label>
                                <input type="text" id="productSubcategory" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., steam, epic-games, office, adobe">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Features (comma separated)</label>
                            <input type="text" id="productFeatures" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., GTA V Included, Exclusive Skins">
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Redeem Points</label>
                                <input type="number" id="productRedeemPoints" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" value="0">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Other Sellers</label>
                                <input type="number" id="productOtherSellers" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" value="0">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Trust Badge</label>
                            <input type="text" id="productTrustBadge" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., TRUSTED SELLER WITH OVER 1000 SALES" value="TRUSTED SELLER WITH OVER 1000 SALES">
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Delivery Speed</label>
                                <select id="productDeliverySpeed" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="toggleCustomDeliverySpeed()">
                                    <option value="Instant">Instant</option>
                                    <option value="5-10 minutes">5-10 minutes</option>
                                    <option value="15-30 minutes">15-30 minutes</option>
                                    <option value="1-2 hours">1-2 hours</option>
                                    <option value="Same day">Same day</option>
                                    <option value="Next day">Next day</option>
                                    <option value="2-3 days">2-3 days</option>
                                    <option value="Custom">Custom</option>
                                </select>
                                <input type="text" id="customDeliverySpeed" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mt-2 hidden" placeholder="Enter custom delivery speed">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Delivery Method</label>
                                <select id="productDeliveryMethod" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="toggleCustomDeliveryMethod()">
                                    <option value="Auto delivery">Auto delivery</option>
                                    <option value="Email delivery">Email delivery</option>
                                    <option value="WhatsApp delivery">WhatsApp delivery</option>
                                    <option value="Discord delivery">Discord delivery</option>
                                    <option value="Manual delivery">Manual delivery</option>
                                    <option value="Digital download">Digital download</option>
                                    <option value="Account credentials">Account credentials</option>
                                    <option value="Custom">Custom</option>
                                </select>
                                <input type="text" id="customDeliveryMethod" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mt-2 hidden" placeholder="Enter custom delivery method">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Activation Region</label>
                            <select id="productActivationRegion" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="toggleCustomActivationRegion()">
                                <option value="Can activate in Sri Lanka">Can activate in Sri Lanka</option>
                                <option value="Global activation">Global activation</option>
                                <option value="Worldwide activation">Worldwide activation</option>
                                <option value="Region free">Region free</option>
                                <option value="No activation required">No activation required</option>
                                <option value="Instant activation">Instant activation</option>
                                <option value="Works worldwide">Works worldwide</option>
                                <option value="Custom">Custom</option>
                            </select>
                            <input type="text" id="customActivationRegion" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mt-2 hidden" placeholder="Enter custom activation region">
                        </div>
                        
                        <div class="flex space-x-3">
                            <button type="submit" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                                Add Product
                            </button>
                            <button type="button" onclick="clearForm()" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-lg font-semibold hover:bg-gray-600 transition-colors">
                                Clear
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Right Side - Product List -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-xl border border-gray-200 p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-900">Manage Products</h2>
                        <div class="flex space-x-2">
                            <button onclick="exportProducts()" class="bg-green-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-green-700 transition-colors">
                                Export JSON
                            </button>
                            <button onclick="importProducts()" class="bg-purple-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-purple-700 transition-colors">
                                Import JSON
                            </button>
                            <button onclick="debugProducts()" class="bg-yellow-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-yellow-700 transition-colors">
                                Debug
                            </button>
                            <button onclick="deleteAllProducts()" class="bg-red-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-red-700 transition-colors">
                                Delete All
                            </button>
                            <button onclick="deleteLocalStorageProducts()" class="bg-orange-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-orange-700 transition-colors">
                                Clear localStorage
                            </button>
                        </div>
                    </div>
                    
                    <!-- Debug Info -->
                    <div id="debugInfo" class="mb-4 p-3 bg-gray-100 rounded-lg text-sm hidden">
                        <strong>Debug Info:</strong>
                        <div id="debugContent"></div>
                    </div>
                    
                    <div id="productList" class="space-y-4">
                        <!-- Products will be loaded here -->
                    </div>
                </div>
                
                <!-- Website Settings Section -->
                <div class="bg-white rounded-xl border border-gray-200 p-6 mt-6">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">Website Settings</h2>
                    
                    <!-- Hero Image Management -->
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold text-gray-800">Hero Section Images</h3>
                        
                        <!-- Image Dimensions Guide -->
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <h4 class="font-semibold text-blue-800 mb-2">üìè Recommended Image Dimensions:</h4>
                            <div class="text-sm text-blue-700 space-y-1">
                                <p><strong>Optimal Size:</strong> 1200 √ó 800 pixels (3:2 ratio)</p>
                                <p><strong>Minimum Size:</strong> 800 √ó 600 pixels</p>
                                <p><strong>Maximum Size:</strong> 1920 √ó 1280 pixels</p>
                                <p><strong>File Format:</strong> JPG, PNG, or WebP</p>
                                <p><strong>File Size:</strong> Under 2MB per image</p>
                            </div>
                        </div>
                        
                        <!-- Hero Image Visibility Toggle -->
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <div>
                                <label class="font-medium text-gray-700">Show Hero Images</label>
                                <p class="text-sm text-gray-500">Display the hero image carousel on the website</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="showHeroImagesToggle" class="sr-only peer" checked>
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Add New Hero Image</label>
                                <div class="space-y-2">
                                    <input type="url" id="newHeroImageUrl" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="https://example.com/hero-image.jpg">
                                    <input type="text" id="newHeroImageAlt" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Image description (optional)">
                                    <div class="flex space-x-2">
                                        <button onclick="addHeroImage()" class="bg-blue-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                                            Add Image
                                        </button>
                                        <button onclick="previewNewHeroImage()" class="bg-gray-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-gray-700 transition-colors">
                                            Preview
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Current Hero Images</label>
                                <div id="heroImagesList" class="space-y-2 max-h-60 overflow-y-auto">
                                    <!-- Hero images will be listed here -->
                                </div>
                            </div>
                            
                            <div class="flex space-x-2">
                                <button onclick="saveHeroImages()" class="bg-green-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-green-700 transition-colors">
                                    Save All Images
                                </button>
                                <button onclick="resetHeroImages()" class="bg-orange-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-orange-700 transition-colors">
                                    Reset to Default
                                </button>
                            </div>
                            
                            <div id="heroImagePreview" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Preview:</label>
                                <div class="border border-gray-300 rounded-lg p-4 bg-gray-50">
                                    <img id="previewImage" src="" alt="Hero Image Preview" class="max-w-full h-auto rounded-lg shadow-md">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Hero Background Image Management -->
                    <div class="space-y-4 mt-6">
                        <h3 class="text-lg font-semibold text-gray-800">Hero Background Image</h3>
                        
                        <!-- Background Image Dimensions Guide -->
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <h4 class="font-semibold text-green-800 mb-2">üìè Background Image Dimensions:</h4>
                            <div class="text-sm text-green-700 space-y-1">
                                <p><strong>Optimal Size:</strong> 1920 √ó 1080 pixels (16:9 ratio)</p>
                                <p><strong>Minimum Size:</strong> 1200 √ó 675 pixels</p>
                                <p><strong>File Format:</strong> JPG, PNG, or WebP</p>
                                <p><strong>File Size:</strong> Under 3MB</p>
                                <p><strong>Note:</strong> Background appears behind the gradient overlay</p>
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Background Image URL</label>
                                <input type="url" id="heroBackgroundImageUrl" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="https://example.com/background-image.jpg">
                            </div>
                            
                            <!-- Background Opacity Control -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Background Opacity: <span id="opacityValue">20%</span></label>
                                <div class="flex items-center space-x-4">
                                    <input type="range" id="heroBackgroundOpacity" min="0" max="100" value="20" class="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider" oninput="updateOpacityValue(this.value)">
                                    <button onclick="resetBackgroundOpacity()" class="bg-gray-500 text-white px-3 py-1 rounded text-sm hover:bg-gray-600 transition-colors">
                                        Reset
                                    </button>
                                </div>
                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                    <span>0% (Hidden)</span>
                                    <span>50% (Medium)</span>
                                    <span>100% (Full)</span>
                                </div>
                            </div>
                            
                            <div class="flex space-x-2">
                                <button onclick="saveHeroBackgroundImage()" class="bg-green-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-green-700 transition-colors">
                                    Save Background
                                </button>
                                <button onclick="previewHeroBackgroundImage()" class="bg-gray-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-gray-700 transition-colors">
                                    Preview
                                </button>
                                <button onclick="removeHeroBackgroundImage()" class="bg-red-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-red-700 transition-colors">
                                    Remove Background
                                </button>
                            </div>
                            
                            <div id="backgroundImagePreview" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Background Preview:</label>
                                <div class="border border-gray-300 rounded-lg p-4 bg-gray-50">
                                    <div class="relative w-full h-32 bg-gradient-to-r from-purple-900 to-red-900 rounded-lg overflow-hidden">
                                        <img id="backgroundPreviewImage" src="" alt="Background Preview" class="absolute inset-0 w-full h-full object-cover opacity-20">
                                        <div class="absolute inset-0 bg-gradient-to-r from-purple-900/80 to-red-900/80"></div>
                                        <div class="absolute inset-0 flex items-center justify-center">
                                            <span class="text-white font-semibold">Background with overlay</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Import Modal -->
    <div id="importModal" class="fixed inset-0 bg-gray-950 bg-opacity-75 flex items-center justify-center z-[1000] p-4 hidden">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-md">
            <h3 class="text-xl font-bold mb-4">Import Products</h3>
            <textarea id="importTextarea" rows="10" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Paste your JSON data here..."></textarea>
            <div class="flex space-x-3 mt-4">
                <button onclick="confirmImport()" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                    Import
                </button>
                <button onclick="closeImportModal()" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-lg font-semibold hover:bg-gray-600 transition-colors">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <script>
        let products = [];
        let categories = [];

        // Check authentication on page load
        window.addEventListener('load', function() {
            checkAuth();
            loadProducts();
        });

        function checkAuth() {
            const isLoggedIn = sessionStorage.getItem('adminLoggedIn');
            const username = sessionStorage.getItem('adminUsername');
            const loginTime = sessionStorage.getItem('adminLoginTime');
            
            if (isLoggedIn !== 'true' || !loginTime) {
                // Redirect to login page
                window.location.href = 'admin-login.html';
                return;
            }
            
            // Check session timeout (30 minutes)
            const currentTime = Date.now();
            const timeDiff = currentTime - parseInt(loginTime);
            const SESSION_TIMEOUT = 30 * 60 * 1000; // 30 minutes
            
            if (timeDiff > SESSION_TIMEOUT) {
                // Session expired
                sessionStorage.clear();
                window.location.href = 'admin-login.html';
                return;
            }
            
            // Display username
            if (username) {
                document.getElementById('adminUsername').textContent = username;
            }
            
            // Generate session ID for logging
            const sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            sessionStorage.setItem('adminSessionId', sessionId);
            
            // Set admin as online
            if (window.FirebaseService) {
                try {
                    FirebaseService.setAdminOnline();
                    // Log admin login
                    FirebaseService.logAdminAction('admin_login', {
                        username: username,
                        sessionId: sessionId,
                        userAgent: navigator.userAgent
                    });
                } catch (error) {
                    console.warn('Firebase operations failed during login:', error);
                    // Continue with login even if Firebase operations fail
                }
            }
            
            // Start inactivity monitoring
            startInactivityMonitoring();
        }

        function startInactivityMonitoring() {
            let inactivityTimer;
            const SESSION_TIMEOUT = 30 * 60 * 1000; // 30 minutes
            
            function resetInactivityTimer() {
                clearTimeout(inactivityTimer);
                inactivityTimer = setTimeout(function() {
                    sessionStorage.clear();
                    window.location.href = 'admin-login.html';
                }, SESSION_TIMEOUT);
            }
            
            // Reset timer on user activity
            document.addEventListener('mousemove', resetInactivityTimer);
            document.addEventListener('keypress', resetInactivityTimer);
            document.addEventListener('click', resetInactivityTimer);
            
            // Start the timer
            resetInactivityTimer();
        }

        function logout() {
            // Log admin logout
            if (window.FirebaseService) {
                try {
                    FirebaseService.logAdminAction('admin_logout', {
                        username: sessionStorage.getItem('adminUsername'),
                        sessionId: sessionStorage.getItem('adminSessionId'),
                        sessionDuration: Date.now() - parseInt(sessionStorage.getItem('adminLoginTime'))
                    });
                    FirebaseService.setAdminOffline();
                } catch (error) {
                    console.warn('Firebase operations failed during logout:', error);
                    // Continue with logout even if Firebase operations fail
                }
            }
            
            // Clear session
            sessionStorage.clear();
            
            // Redirect to login page
            window.location.href = 'admin-login.html';
        }

        // Auto-logout on tab close or inactivity
        window.addEventListener('beforeunload', function() {
            // Set admin as offline when leaving
            if (window.FirebaseService) {
                try {
                    FirebaseService.setAdminOffline();
                } catch (error) {
                    console.warn('Failed to set admin offline:', error);
                }
            }
        });

        // Load products on page load
        window.addEventListener('load', function() {
            loadProducts();
        });

        function loadProducts() {
            console.log('Starting to load products...');
            // Try to load from Firebase first
            if (window.FirebaseService) {
                console.log('Firebase service available, attempting to load from Firebase...');
                FirebaseService.getProducts()
                    .then(firebaseProducts => {
                        console.log('Firebase returned products:', firebaseProducts);
                        if (firebaseProducts && firebaseProducts.length > 0) {
                            products = firebaseProducts;
                            displayProducts();
                            console.log('Successfully loaded products from Firebase:', products);
                        } else {
                            console.log('No products in Firebase, falling back to localStorage');
                            loadFromLocalStorage();
                        }
                    })
                    .catch(error => {
                        console.error('Error loading from Firebase:', error);
                        console.log('Falling back to localStorage due to Firebase error');
                        loadFromLocalStorage();
                    });
            } else {
                console.log('Firebase service not available, loading from localStorage');
                loadFromLocalStorage();
            }
        }

        function loadFromLocalStorage() {
            console.log('Loading products from localStorage...');
            // In a real application, you would fetch this from a server
            // For now, we'll use localStorage or load from products.json
            const storedProducts = localStorage.getItem('sShopProducts');
            console.log('Stored products from localStorage:', storedProducts);
            
            if (storedProducts) {
                try {
                    products = JSON.parse(storedProducts);
                    console.log('Successfully loaded products from localStorage:', products);
                    displayProducts();
                } catch (error) {
                    console.error('Error parsing localStorage data:', error);
                    loadDefaultProducts();
                }
            } else {
                console.log('No stored products in localStorage, loading default products');
                loadDefaultProducts();
            }
        }

        function loadDefaultProducts() {
            console.log('Loading default products...');
            // Load default products
            fetch('products.json')
                .then(response => {
                    console.log('products.json response:', response);
                    if (!response.ok) {
                        throw new Error('products.json not found');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Loaded data from products.json:', data);
                    products = data.products || [];
                    categories = data.categories || [];
                    console.log('Successfully loaded products from products.json:', products);
                    displayProducts();
                })
                .catch(error => {
                    console.error('Error loading products.json:', error);
                    // Load sample data if file not found
                    products = [];
                    console.log('Using empty products array as fallback');
                    displayProducts();
                });
        }

        function displayProducts() {
            const productList = document.getElementById('productList');
            console.log('Displaying products:', products);
            console.log('Product list element:', productList);
            
            if (!productList) {
                console.error('Product list element not found!');
                return;
            }
            
            productList.innerHTML = '';

            if (products.length === 0) {
                productList.innerHTML = `
                    <div class="text-center py-8">
                        <p class="text-gray-500 mb-4">No products found. Add your first product using the form on the left.</p>
                        <button onclick="addTestProducts()" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                            Add Test Products
                        </button>
                    </div>`;
                return;
            }

            products.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow';
                productCard.innerHTML = `
                    <div class="flex items-center space-x-4">
                        <img src="${product.image}" alt="${product.name}" class="w-16 h-16 object-cover rounded-lg">
                        <div class="flex-1">
                            <h3 class="font-semibold text-gray-900">${product.name}</h3>
                            <p class="text-sm text-gray-600">${product.description}</p>
                            <div class="flex items-center space-x-4 mt-2 text-sm">
                                <span class="text-green-600 font-semibold">LKR ${product.price.toLocaleString()}</span>
                                <span class="text-gray-500">${product.availability} available</span>
                                <span class="text-blue-600 font-semibold">${product.sold || 0} sold</span>
                                <span class="text-gray-500">${product.category}</span>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="editProduct('${product.id}')" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">
                                Edit
                            </button>
                            <button onclick="deleteProduct('${product.id}')" class="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700">
                                Delete
                            </button>
                        </div>
                    </div>
                `;
                productList.appendChild(productCard);
            });
        }

        function addTestProducts() {
            console.log('Adding test products...');
            alert('Test products feature has been removed. Please add products manually using the form on the left.');
        }

        function getDeliverySpeedValue() {
            const deliverySpeedSelect = document.getElementById('productDeliverySpeed');
            const customDeliverySpeed = document.getElementById('customDeliverySpeed');
            
            if (deliverySpeedSelect.value === 'Custom') {
                return customDeliverySpeed.value.trim();
            }
            return deliverySpeedSelect.value;
        }

        function getDeliveryMethodValue() {
            const deliveryMethodSelect = document.getElementById('productDeliveryMethod');
            const customDeliveryMethod = document.getElementById('customDeliveryMethod');
            
            if (deliveryMethodSelect.value === 'Custom') {
                return customDeliveryMethod.value.trim();
            }
            return deliveryMethodSelect.value;
        }

        function getActivationRegionValue() {
            const activationRegionSelect = document.getElementById('productActivationRegion');
            const customActivationRegion = document.getElementById('customActivationRegion');
            
            if (activationRegionSelect.value === 'Custom') {
                return customActivationRegion.value.trim();
            }
            return activationRegionSelect.value;
        }

        // Product form submission
        document.getElementById('productForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const productId = document.getElementById('productId').value;
            const productData = {
                name: document.getElementById('productName').value.trim(),
                description: document.getElementById('productDescription').value.trim(),
                price: parseFloat(document.getElementById('productPrice').value),
                availability: parseInt(document.getElementById('productAvailability').value),
                soldCount: parseInt(document.getElementById('productSoldCount').value) || 0,
                image: document.getElementById('productImage').value.trim(),
                category: document.getElementById('productCategory').value,
                subcategory: document.getElementById('productSubcategory').value.trim(),
                features: document.getElementById('productFeatures').value.trim(),
                redeemPoints: parseInt(document.getElementById('productRedeemPoints').value) || 0,
                otherSellers: parseInt(document.getElementById('productOtherSellers').value) || 0,
                trustBadge: document.getElementById('productTrustBadge').value.trim(),
                deliverySpeed: getDeliverySpeedValue(),
                deliveryMethod: getDeliveryMethodValue(),
                activationRegion: getActivationRegionValue()
            };
            
            // Validation
            if (!productData.name || !productData.description || !productData.price || !productData.image || !productData.category) {
                alert('Please fill in all required fields (Name, Description, Price, Image URL, Category)');
                return;
            }
            
            if (productData.price <= 0) {
                alert('Price must be greater than 0');
                return;
            }
            
            if (productData.availability < 0) {
                alert('Availability cannot be negative');
                return;
            }
            
            // Generate unique ID if new product
            if (!productId) {
                productData.id = 'PROD-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                productData.createdAt = new Date().toISOString();
                productData.updatedAt = new Date().toISOString();
                
                // Add to products array
                products.unshift(productData);
                
                // Log admin action
                if (window.FirebaseService) {
                    FirebaseService.logAdminAction('product_created', {
                        productId: productData.id,
                        productName: productData.name,
                        adminEmail: sessionStorage.getItem('adminEmail')
                    });
                }
                
                alert('Product added successfully!');
                } else {
                // Update existing product
                const existingIndex = products.findIndex(p => p.id === productId);
                if (existingIndex !== -1) {
                    productData.id = productId;
                    productData.createdAt = products[existingIndex].createdAt;
                    productData.updatedAt = new Date().toISOString();
                    
                    products[existingIndex] = productData;
                    
                    // Log admin action
                    if (window.FirebaseService) {
                        FirebaseService.logAdminAction('product_updated', {
                            productId: productData.id,
                            productName: productData.name,
                            adminEmail: sessionStorage.getItem('adminEmail')
                        });
                    }
                    
                    alert('Product updated successfully!');
                }
            }
            
            // Save to localStorage
            localStorage.setItem('sShopProducts', JSON.stringify(products));
            
            // Save to Firebase if available
            if (window.FirebaseService) {
                FirebaseService.saveProducts(products)
                    .then(() => {
                        console.log('Products saved to Firebase successfully');
                    })
                    .catch(error => {
                        console.error('Error saving to Firebase:', error);
                    });
            }
            
            // Clear form and refresh display
            clearForm();
            displayProducts();
        });

        function clearForm() {
            document.getElementById('productForm').reset();
            document.getElementById('productId').value = '';
            document.getElementById('productSoldCount').value = '0';
            document.getElementById('productRedeemPoints').value = '0';
            document.getElementById('productOtherSellers').value = '0';
            document.getElementById('productTrustBadge').value = 'TRUSTED SELLER WITH OVER 1000 SALES';
            
            // Reset custom input fields
            document.getElementById('customDeliverySpeed').classList.add('hidden');
            document.getElementById('customDeliveryMethod').classList.add('hidden');
            document.getElementById('customActivationRegion').classList.add('hidden');
        }

        function editProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) {
                alert('Product not found!');
                return;
            }
            
            // Fill form with product data
            document.getElementById('productId').value = product.id;
            document.getElementById('productName').value = product.name || '';
            document.getElementById('productDescription').value = product.description || '';
            document.getElementById('productPrice').value = product.price || '';
            document.getElementById('productAvailability').value = product.availability || '';
            document.getElementById('productSoldCount').value = product.soldCount || 0;
            document.getElementById('productImage').value = product.image || '';
            document.getElementById('productCategory').value = product.category || '';
            document.getElementById('productSubcategory').value = product.subcategory || '';
            document.getElementById('productFeatures').value = Array.isArray(product.features) ? product.features.join(', ') : (product.features || '');
            document.getElementById('productRedeemPoints').value = product.redeemPoints || 0;
            document.getElementById('productOtherSellers').value = product.otherSellers || 0;
            document.getElementById('productTrustBadge').value = product.trustBadge || 'TRUSTED SELLER WITH OVER 1000 SALES';
            
            // Set delivery speed
            if (product.deliverySpeed) {
                const deliverySpeedSelect = document.getElementById('productDeliverySpeed');
                const customDeliverySpeed = document.getElementById('customDeliverySpeed');
                
                if (['Instant', '5-10 minutes', '15-30 minutes', '1-2 hours', 'Same day', 'Next day', '2-3 days'].includes(product.deliverySpeed)) {
                    deliverySpeedSelect.value = product.deliverySpeed;
                    customDeliverySpeed.classList.add('hidden');
                    } else {
                    deliverySpeedSelect.value = 'Custom';
                    customDeliverySpeed.classList.remove('hidden');
                    customDeliverySpeed.value = product.deliverySpeed;
                }
            }
            
            // Set delivery method
            if (product.deliveryMethod) {
                const deliveryMethodSelect = document.getElementById('productDeliveryMethod');
                const customDeliveryMethod = document.getElementById('customDeliveryMethod');
                
                if (['Auto delivery', 'Email delivery', 'WhatsApp delivery', 'Discord delivery', 'Manual delivery', 'Digital download', 'Account credentials'].includes(product.deliveryMethod)) {
                    deliveryMethodSelect.value = product.deliveryMethod;
                    customDeliveryMethod.classList.add('hidden');
                } else {
                    deliveryMethodSelect.value = 'Custom';
                    customDeliveryMethod.classList.remove('hidden');
                    customDeliveryMethod.value = product.deliveryMethod;
                }
            }
            
            // Set activation region
            if (product.activationRegion) {
                const activationRegionSelect = document.getElementById('productActivationRegion');
                const customActivationRegion = document.getElementById('customActivationRegion');
                
                if (['Can activate in Sri Lanka', 'Global activation', 'Worldwide activation', 'Region free', 'No activation required', 'Instant activation', 'Works worldwide'].includes(product.activationRegion)) {
                    activationRegionSelect.value = product.activationRegion;
                    customActivationRegion.classList.add('hidden');
                } else {
                    activationRegionSelect.value = 'Custom';
                    customActivationRegion.classList.remove('hidden');
                    customActivationRegion.value = product.activationRegion;
                }
            }
            
            // Scroll to form
            document.getElementById('productForm').scrollIntoView({ behavior: 'smooth' });
        }

        async function deleteProduct(productId) {
            if (!confirm('Are you sure you want to delete this product?')) {
                return;
            }
            
            const product = products.find(p => p.id === productId);
            if (!product) {
                alert('Product not found!');
                return;
            }
            
            // Remove from products array
            products = products.filter(p => p.id !== productId);
            
            // Save to localStorage
            localStorage.setItem('sShopProducts', JSON.stringify(products));
            
            // Save to Firebase if available
                if (window.FirebaseService) {
                try {
                    await FirebaseService.saveProducts(products);
                    
                    // Log admin action
                        FirebaseService.logAdminAction('product_deleted', {
                            productId: productId,
                        productName: product.name,
                        adminEmail: sessionStorage.getItem('adminEmail')
                    });
                } catch (error) {
                    console.error('Error saving to Firebase:', error);
                }
            }
            
            alert('Product deleted successfully!');
            displayProducts();
        }

        function generateId() {
            return 'product-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        }

        function debugProducts() {
            const debugInfo = document.getElementById('debugInfo');
            const debugContent = document.getElementById('debugContent');
            debugContent.innerHTML = '';

            debugContent.innerHTML += `<p><strong>Current Products:</strong></p>`;
            products.forEach(product => {
                debugContent.innerHTML += `<p>ID: ${product.id}, Name: ${product.name}, Category: ${product.category}, Availability: ${product.availability}, Sold: ${product.sold}</p>`;
            });

            debugContent.innerHTML += `<p><strong>Current Categories:</strong></p>`;
            categories.forEach(cat => {
                debugContent.innerHTML += `<p>${cat}</p>`;
            });

            debugInfo.classList.remove('hidden');
        }

        async function deleteAllProducts() {
            if (confirm('Are you sure you want to delete ALL products? This action cannot be undone.')) {
                try {
                    if (window.FirebaseService) {
                        // Log bulk deletion
                        FirebaseService.logAdminAction('all_products_deleted', {
                            totalProducts: products.length,
                            categories: [...new Set(products.map(p => p.category))],
                            totalValue: products.reduce((sum, p) => sum + (p.price || 0), 0)
                        });
                        
                        // Delete all products from Firebase
                        await FirebaseService.deleteAllProducts();
                        alert('All products deleted successfully from Firebase!');
                        products = []; // Clear local products array
                        saveProducts(); // Save empty array to localStorage
                        displayProducts();
                    } else {
                        // Delete all products from localStorage
                        localStorage.removeItem('sShopProducts');
                        alert('All products deleted successfully from localStorage!');
                        products = []; // Clear local products array
                        displayProducts();
                    }
                } catch (error) {
                    console.error('Error deleting all products:', error);
                    alert('Error deleting all products. Please try again.');
                }
            }
        }

        function deleteLocalStorageProducts() {
            if (confirm('Are you sure you want to delete ALL products from localStorage? This action cannot be undone.')) {
                localStorage.removeItem('sShopProducts');
                alert('All products deleted successfully from localStorage!');
                products = []; // Clear local products array
                displayProducts();
            }
        }

        function toggleCustomDeliverySpeed() {
            const customSpeedInput = document.getElementById('customDeliverySpeed');
            const selectedSpeed = document.getElementById('productDeliverySpeed').value;

            if (selectedSpeed === 'Custom') {
                customSpeedInput.classList.remove('hidden');
                customSpeedInput.value = ''; // Clear default value
                customSpeedInput.focus();
            } else {
                customSpeedInput.classList.add('hidden');
                customSpeedInput.value = ''; // Clear input value
            }
        }

        function toggleCustomDeliveryMethod() {
            const customMethodInput = document.getElementById('customDeliveryMethod');
            const selectedMethod = document.getElementById('productDeliveryMethod').value;

            if (selectedMethod === 'Custom') {
                customMethodInput.classList.remove('hidden');
                customMethodInput.value = ''; // Clear default value
                customMethodInput.focus();
            } else {
                customMethodInput.classList.add('hidden');
                customMethodInput.value = ''; // Clear input value
            }
        }

        function toggleCustomActivationRegion() {
            const customActivationInput = document.getElementById('customActivationRegion');
            const selectedRegion = document.getElementById('productActivationRegion').value;

            if (selectedRegion === 'Custom') {
                customActivationInput.classList.remove('hidden');
                customActivationInput.value = ''; // Clear default value
                customActivationInput.focus();
            } else {
                customActivationInput.classList.add('hidden');
                customActivationInput.value = ''; // Clear input value
            }
        }

        // Hero Image Management Functions
        function addHeroImage() {
            const newHeroImageUrl = document.getElementById('newHeroImageUrl').value.trim();
            const newHeroImageAlt = document.getElementById('newHeroImageAlt').value.trim();
            const heroImagesList = document.getElementById('heroImagesList');

            if (!newHeroImageUrl) {
                alert('Please enter a valid image URL for the new hero image.');
                return;
            }

            const heroImageItem = document.createElement('div');
            heroImageItem.className = 'flex items-center justify-between bg-gray-100 p-2 rounded-lg';
            heroImageItem.innerHTML = `
                <div class="flex items-center space-x-2">
                    <img src="${newHeroImageUrl}" alt="${newHeroImageAlt || 'Hero Image'}" class="w-10 h-10 object-cover rounded-md">
                    <span class="text-sm text-gray-700">${newHeroImageAlt || 'Hero Image'}</span>
                </div>
                <button onclick="removeHeroImage(this)" class="text-red-600 hover:text-red-800 text-lg">
                    √ó
                </button>
            `;
            heroImagesList.appendChild(heroImageItem);

            document.getElementById('newHeroImageUrl').value = '';
            document.getElementById('newHeroImageAlt').value = '';
        }

        function removeHeroImage(button) {
            const heroImageItem = button.closest('.flex');
            heroImageItem.remove();
        }

        function previewNewHeroImage() {
            const newHeroImageUrl = document.getElementById('newHeroImageUrl').value.trim();
            const previewDiv = document.getElementById('heroImagePreview');
            const previewImage = document.getElementById('previewImage');
            
            if (!newHeroImageUrl) {
                alert('Please enter a valid image URL first');
                return;
            }
            
            previewImage.src = newHeroImageUrl;
            previewImage.onload = function() {
                previewDiv.classList.remove('hidden');
                
                // Check image dimensions
                const width = this.naturalWidth;
                const height = this.naturalHeight;
                const aspectRatio = (width / height).toFixed(2);
                
                // Create dimension info
                const dimensionInfo = document.createElement('div');
                dimensionInfo.className = 'mt-2 p-2 bg-gray-100 rounded text-xs';
                dimensionInfo.innerHTML = `
                    <p><strong>Image Dimensions:</strong> ${width} √ó ${height} pixels</p>
                    <p><strong>Aspect Ratio:</strong> ${aspectRatio}</p>
                    ${width < 800 || height < 600 ? '<p class="text-red-600">‚ö†Ô∏è Image is smaller than recommended minimum (800√ó600)</p>' : ''}
                    ${width > 1920 || height > 1280 ? '<p class="text-orange-600">‚ö†Ô∏è Image is larger than recommended maximum (1920√ó1280)</p>' : ''}
                    ${width >= 1200 && height >= 800 ? '<p class="text-green-600">‚úÖ Optimal size for hero images</p>' : ''}
                `;
                
                // Remove existing dimension info and add new one
                const existingInfo = previewDiv.querySelector('.bg-gray-100');
                if (existingInfo) {
                    existingInfo.remove();
                }
                previewDiv.appendChild(dimensionInfo);
            };
            previewImage.onerror = function() {
                alert('Error loading image. Please check the URL.');
                previewDiv.classList.add('hidden');
            };
        }

        function saveHeroImages() {
            const heroImages = [];
            document.querySelectorAll('#heroImagesList img').forEach(img => {
                heroImages.push({
                    url: img.src,
                    alt: img.alt
                });
            });

            if (heroImages.length === 0) {
                alert('No hero images to save. Please add at least one.');
                return;
            }

            // Save to localStorage
            localStorage.setItem('sShopHeroImages', JSON.stringify(heroImages));
            
            // Save to Firebase if available
            if (window.FirebaseService) {
                FirebaseService.updateWebsiteSettings({ heroImages: heroImages })
                    .then(() => {
                        alert('Hero images saved successfully!');
                    })
                    .catch(error => {
                        console.error('Error saving to Firebase:', error);
                        alert('Hero images saved to localStorage. Firebase save failed.');
                    });
            } else {
                alert('Hero images saved successfully!');
            }
        }

        function resetHeroImages() {
            const defaultImages = [
                {
                    url: 'https://placehold.co/600x400/805ad5/ffffff?text=S+Shop+LK',
                    alt: 'S Shop LK Hero 1'
                },
                {
                    url: 'https://placehold.co/600x400/667eea/ffffff?text=Gaming+Products',
                    alt: 'S Shop LK Hero 2'
                },
                {
                    url: 'https://placehold.co/600x400/764ba2/ffffff?text=Best+Deals',
                    alt: 'S Shop LK Hero 3'
                }
            ];

            // Save the reset
            localStorage.setItem('sShopHeroImages', JSON.stringify(defaultImages));
            
            // Save to Firebase if available
            if (window.FirebaseService) {
                FirebaseService.updateWebsiteSettings({ heroImages: defaultImages })
                    .then(() => {
                        alert('Hero images reset to default!');
                        loadHeroImages();
                    })
                    .catch(error => {
                        console.error('Error saving to Firebase:', error);
                        alert('Hero images reset to default in localStorage.');
                    });
            } else {
                alert('Hero images reset to default!');
            }
        }

        // Load hero images on page load
        function loadHeroImages() {
            const heroImages = JSON.parse(localStorage.getItem('sShopHeroImages') || '[]');
            const heroImagesList = document.getElementById('heroImagesList');
            heroImagesList.innerHTML = '';

            if (heroImages.length === 0) {
                // Load default images
                const defaultImages = [
                    {
                        url: 'https://placehold.co/600x400/805ad5/ffffff?text=S+Shop+LK',
                        alt: 'S Shop LK Hero 1'
                    },
                    {
                        url: 'https://placehold.co/600x400/667eea/ffffff?text=Gaming+Products',
                        alt: 'S Shop LK Hero 2'
                    },
                    {
                        url: 'https://placehold.co/600x400/764ba2/ffffff?text=Best+Deals',
                        alt: 'S Shop LK Hero 3'
                    }
                ];

                defaultImages.forEach(image => {
                    const heroImageItem = document.createElement('div');
                    heroImageItem.className = 'flex items-center justify-between bg-gray-100 p-2 rounded-lg';
                    heroImageItem.innerHTML = `
                        <div class="flex items-center space-x-2">
                            <img src="${image.url}" alt="${image.alt}" class="w-10 h-10 object-cover rounded-md">
                            <span class="text-sm text-gray-700">${image.alt}</span>
                        </div>
                        <button onclick="removeHeroImage(this)" class="text-red-600 hover:text-red-800 text-lg">
                            √ó
                        </button>
                    `;
                    heroImagesList.appendChild(heroImageItem);
                });
            } else {
                heroImages.forEach(image => {
                    const heroImageItem = document.createElement('div');
                    heroImageItem.className = 'flex items-center justify-between bg-gray-100 p-2 rounded-lg';
                    heroImageItem.innerHTML = `
                        <div class="flex items-center space-x-2">
                            <img src="${image.url}" alt="${image.alt}" class="w-10 h-10 object-cover rounded-md">
                            <span class="text-sm text-gray-700">${image.alt}</span>
                        </div>
                        <button onclick="removeHeroImage(this)" class="text-red-600 hover:text-red-800 text-lg">
                            √ó
                        </button>
                    `;
                    heroImagesList.appendChild(heroImageItem);
                });
            }
        }

        // Load hero images when page loads
        window.addEventListener('load', function() {
            loadHeroImages();
            loadHeroBackgroundImageSettings();
            loadHeroImageVisibilitySettings();
        });

        // Background Image Management Functions
        function saveHeroBackgroundImage() {
            const backgroundImageUrl = document.getElementById('heroBackgroundImageUrl').value.trim();
            const backgroundOpacity = document.getElementById('heroBackgroundOpacity').value;
            
            if (!backgroundImageUrl) {
                alert('Please enter a valid background image URL');
                return;
            }
            
            const backgroundSettings = {
                url: backgroundImageUrl,
                opacity: parseInt(backgroundOpacity)
            };
            
            // Save to localStorage
            localStorage.setItem('sShopHeroBackgroundImage', JSON.stringify(backgroundSettings));
            
            // Save to Firebase if available
            if (window.FirebaseService) {
                FirebaseService.updateWebsiteSettings({ heroBackgroundImage: backgroundSettings })
                    .then(() => {
                        alert('Background image saved successfully!');
                    })
                    .catch(error => {
                        console.error('Error saving to Firebase:', error);
                        alert('Background image saved to localStorage. Firebase save failed.');
                    });
            } else {
                alert('Background image saved successfully!');
            }
        }

        function previewHeroBackgroundImage() {
            const backgroundImageUrl = document.getElementById('heroBackgroundImageUrl').value.trim();
            const backgroundOpacity = document.getElementById('heroBackgroundOpacity').value;
            const previewDiv = document.getElementById('backgroundImagePreview');
            const previewImage = document.getElementById('backgroundPreviewImage');
            
            if (!backgroundImageUrl) {
                alert('Please enter a valid background image URL first');
                return;
            }
            
            previewImage.src = backgroundImageUrl;
            previewImage.style.opacity = backgroundOpacity / 100;
            previewImage.onload = function() {
                previewDiv.classList.remove('hidden');
                
                // Check image dimensions
                const width = this.naturalWidth;
                const height = this.naturalHeight;
                const aspectRatio = (width / height).toFixed(2);
                
                // Create dimension info
                const dimensionInfo = document.createElement('div');
                dimensionInfo.className = 'mt-2 p-2 bg-gray-100 rounded text-xs';
                dimensionInfo.innerHTML = `
                    <p><strong>Background Dimensions:</strong> ${width} √ó ${height} pixels</p>
                    <p><strong>Aspect Ratio:</strong> ${aspectRatio}</p>
                    <p><strong>Opacity:</strong> ${backgroundOpacity}%</p>
                    ${width < 1200 || height < 675 ? '<p class="text-red-600">‚ö†Ô∏è Image is smaller than recommended minimum (1200√ó675)</p>' : ''}
                    ${width >= 1920 && height >= 1080 ? '<p class="text-green-600">‚úÖ Optimal size for background images</p>' : ''}
                `;
                
                // Remove existing dimension info and add new one
                const existingInfo = previewDiv.querySelector('.bg-gray-100');
                if (existingInfo) {
                    existingInfo.remove();
                }
                previewDiv.appendChild(dimensionInfo);
            };
            previewImage.onerror = function() {
                alert('Error loading background image. Please check the URL.');
                previewDiv.classList.add('hidden');
            };
        }

        function removeHeroBackgroundImage() {
            // Clear the input
            document.getElementById('heroBackgroundImageUrl').value = '';
            document.getElementById('heroBackgroundOpacity').value = '20';
            updateOpacityValue('20');
            
            // Remove from localStorage
            localStorage.removeItem('sShopHeroBackgroundImage');
            
            // Remove from Firebase if available
            if (window.FirebaseService) {
                FirebaseService.updateWebsiteSettings({ heroBackgroundImage: null })
                    .then(() => {
                        alert('Background image removed successfully!');
                    })
                    .catch(error => {
                        console.error('Error removing from Firebase:', error);
                        alert('Background image removed from localStorage.');
                    });
            } else {
                alert('Background image removed successfully!');
            }
        }

        function loadHeroBackgroundImageSettings() {
            const backgroundImageData = localStorage.getItem('sShopHeroBackgroundImage');
            if (backgroundImageData) {
                try {
                    const settings = JSON.parse(backgroundImageData);
                    if (typeof settings === 'string') {
                        // Legacy format (just URL string)
                        document.getElementById('heroBackgroundImageUrl').value = settings;
                        document.getElementById('heroBackgroundOpacity').value = '20';
                        updateOpacityValue('20');
                    } else {
                        // New format (object with URL and opacity)
                        document.getElementById('heroBackgroundImageUrl').value = settings.url || '';
                        document.getElementById('heroBackgroundOpacity').value = settings.opacity || '20';
                        updateOpacityValue(settings.opacity || '20');
                    }
                } catch (error) {
                    // Fallback to legacy format
                    document.getElementById('heroBackgroundImageUrl').value = backgroundImageData;
                    document.getElementById('heroBackgroundOpacity').value = '20';
                    updateOpacityValue('20');
                }
            }
        }

        // Hero Image Visibility Management Functions
        function saveHeroImageVisibility() {
            const showHeroImages = document.getElementById('showHeroImagesToggle').checked;
            
            // Save to localStorage
            localStorage.setItem('sShopShowHeroImages', showHeroImages.toString());
            
            // Save to Firebase if available
            if (window.FirebaseService) {
                FirebaseService.updateWebsiteSettings({ showHeroImages: showHeroImages })
                    .then(() => {
                        alert('Hero image visibility setting saved successfully!');
                    })
                    .catch(error => {
                        console.error('Error saving to Firebase:', error);
                        alert('Setting saved to localStorage. Firebase save failed.');
                    });
            } else {
                alert('Hero image visibility setting saved successfully!');
            }
        }

        function loadHeroImageVisibilitySettings() {
            const showHeroImages = localStorage.getItem('sShopShowHeroImages');
            if (showHeroImages !== null) {
                document.getElementById('showHeroImagesToggle').checked = showHeroImages === 'true';
            } else {
                // Default to true if no setting is saved
                document.getElementById('showHeroImagesToggle').checked = true;
            }
        }

        // Add event listeners for the toggle
        document.addEventListener('DOMContentLoaded', function() {
            const toggle = document.getElementById('showHeroImagesToggle');
            if (toggle) {
                toggle.addEventListener('change', saveHeroImageVisibility);
            }
        });

        // Background Opacity Control Functions
        function updateOpacityValue(value) {
            document.getElementById('opacityValue').textContent = `${value}%`;
            const previewImage = document.getElementById('backgroundPreviewImage');
            if (previewImage) {
                previewImage.style.opacity = value / 100;
            }
        }

        function resetBackgroundOpacity() {
            document.getElementById('heroBackgroundOpacity').value = '20';
            updateOpacityValue('20');
        }

        // Export and Import Functions
        function exportProducts() {
            try {
                const productsData = JSON.stringify(products, null, 2);
                const blob = new Blob([productsData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `s-shop-products-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                alert('Products exported successfully!');
            } catch (error) {
                console.error('Error exporting products:', error);
                alert('Error exporting products. Please try again.');
            }
        }

        function importProducts() {
            try {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = function(e) {
                    const file = e.target.files[0];
                    if (!file) {
                        alert('No file selected.');
                        return;
                    }
                    
                    // Check file size (max 10MB)
                    if (file.size > 10 * 1024 * 1024) {
                        alert('File too large. Please select a file smaller than 10MB.');
                        return;
                    }
                    
                    // Check file extension
                    if (!file.name.toLowerCase().endsWith('.json')) {
                        alert('Please select a valid JSON file (.json extension).');
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const fileContent = e.target.result;
                            console.log('=== IMPORT DEBUG INFO ===');
                            console.log('File name:', file.name);
                            console.log('File size:', file.size, 'bytes');
                            console.log('File content preview:', fileContent.substring(0, 500) + '...');
                            
                            // Try to parse JSON
                            let importedData;
                            try {
                                importedData = JSON.parse(fileContent);
                                console.log('JSON parsed successfully:', importedData);
                            } catch (parseError) {
                                console.error('JSON parse error:', parseError);
                                alert(`JSON parsing failed: ${parseError.message}\n\nPlease ensure your file contains valid JSON format.`);
                                return;
                            }
                            
                            // Handle different data structures
                            let importedProducts = [];
                            
                            if (Array.isArray(importedData)) {
                                // Direct array of products
                                importedProducts = importedData;
                                console.log('Found direct array of products:', importedProducts.length);
                            } else if (importedData.products && Array.isArray(importedData.products)) {
                                // Object with products array
                                importedProducts = importedData.products;
                                console.log('Found products array in object:', importedProducts.length);
                            } else if (typeof importedData === 'object' && importedData !== null) {
                                // Single product object
                                importedProducts = [importedData];
                                console.log('Found single product object');
                            } else {
                                alert('File does not contain valid product data.\n\nExpected formats:\n- Array of products: [{"name": "...", "price": "..."}, ...]\n- Object with products: {"products": [{"name": "...", "price": "..."}, ...]}\n- Single product: {"name": "...", "price": "..."}');
                                return;
                            }
                            
                            if (importedProducts.length === 0) {
                                alert('No products found in the file.');
                                return;
                            }
                            
                            console.log('Processing', importedProducts.length, 'products...');
                            
                            // Process and validate each product
                            const validProducts = [];
                            const invalidProducts = [];
                            const warnings = [];
                            
                            importedProducts.forEach((product, index) => {
                                console.log(`Processing product ${index + 1}:`, product);
                                
                                if (!product || typeof product !== 'object') {
                                    invalidProducts.push(`Product ${index + 1}: Not a valid object`);
                                    return;
                                }
                                
                                // Create a clean product object with only valid fields
                                const cleanProduct = {};
                                
                                // Required fields validation
                                if (!product.name || typeof product.name !== 'string' || product.name.trim() === '') {
                                    invalidProducts.push(`Product ${index + 1}: Missing or invalid name`);
                                    return;
                                }
                                
                                if (!product.price) {
                                    invalidProducts.push(`Product ${index + 1}: Missing price`);
                                    return;
                                }
                                
                                // Price validation and conversion
                                let price;
                                if (typeof product.price === 'string') {
                                    price = parseFloat(product.price.replace(/[^\d.-]/g, ''));
                                    if (isNaN(price)) {
                                        invalidProducts.push(`Product ${index + 1}: Invalid price format`);
                                        return;
                                    }
                                } else if (typeof product.price === 'number') {
                                    price = product.price;
                                } else {
                                    invalidProducts.push(`Product ${index + 1}: Invalid price type`);
                                    return;
                                }
                                
                                if (price <= 0) {
                                    invalidProducts.push(`Product ${index + 1}: Price must be greater than 0`);
                                    return;
                                }
                                
                                // Copy valid fields
                                cleanProduct.name = product.name.trim();
                                cleanProduct.price = price;
                                cleanProduct.description = product.description || '';
                                cleanProduct.availability = parseInt(product.availability) || 0;
                                cleanProduct.soldCount = parseInt(product.soldCount) || 0;
                                cleanProduct.image = product.image || '';
                                cleanProduct.category = product.category || 'Uncategorized';
                                cleanProduct.subcategory = product.subcategory || '';
                                
                                // Handle features field - convert string to array if needed
                                if (product.features) {
                                    if (Array.isArray(product.features)) {
                                        cleanProduct.features = product.features;
                                    } else if (typeof product.features === 'string') {
                                        // Split by commas, semicolons, or newlines and clean up
                                        const featuresArray = product.features
                                            .split(/[,;\n\r]+/)
                                            .map(feature => feature.trim())
                                            .filter(feature => feature.length > 0);
                                        cleanProduct.features = featuresArray.length > 0 ? featuresArray : '';
                                    } else {
                                        cleanProduct.features = '';
                                    }
                                } else {
                                    cleanProduct.features = '';
                                }
                                
                                cleanProduct.redeemPoints = parseInt(product.redeemPoints) || 0;
                                cleanProduct.otherSellers = parseInt(product.otherSellers) || 0;
                                cleanProduct.trustBadge = product.trustBadge || '';
                                cleanProduct.deliverySpeed = product.deliverySpeed || 'Standard';
                                cleanProduct.deliveryMethod = product.deliveryMethod || 'Digital';
                                cleanProduct.activationRegion = product.activationRegion || 'Global';
                                
                                // Generate new ID and timestamps
                                cleanProduct.id = 'PROD-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                                cleanProduct.createdAt = new Date().toISOString();
                                cleanProduct.updatedAt = new Date().toISOString();
                                
                                // Check for warnings
                                if (!product.description) warnings.push(`Product ${index + 1}: No description`);
                                if (!product.image) warnings.push(`Product ${index + 1}: No image URL`);
                                if (!product.category) warnings.push(`Product ${index + 1}: No category`);
                                
                                validProducts.push(cleanProduct);
                                console.log(`Product ${index + 1} processed successfully:`, cleanProduct);
                            });
                            
                            console.log('Validation complete:', {
                                total: importedProducts.length,
                                valid: validProducts.length,
                                invalid: invalidProducts.length,
                                warnings: warnings.length
                            });
                            
                            if (validProducts.length === 0) {
                                alert(`No valid products found in the file.\n\nValidation errors:\n${invalidProducts.join('\n')}`);
                                return;
                            }
                            
                            // Show summary and ask for confirmation
                            let confirmMessage = `Found ${validProducts.length} valid products to import.\n\n`;
                            
                            if (invalidProducts.length > 0) {
                                confirmMessage += `‚ö†Ô∏è ${invalidProducts.length} products were skipped due to errors:\n${invalidProducts.slice(0, 5).join('\n')}`;
                                if (invalidProducts.length > 5) {
                                    confirmMessage += `\n... and ${invalidProducts.length - 5} more errors`;
                                }
                                confirmMessage += '\n\n';
                            }
                            
                            if (warnings.length > 0) {
                                confirmMessage += `‚ö†Ô∏è ${warnings.length} warnings (products will still be imported):\n${warnings.slice(0, 5).join('\n')}`;
                                if (warnings.length > 5) {
                                    confirmMessage += `\n... and ${warnings.length - 5} more warnings`;
                                }
                                confirmMessage += '\n\n';
                            }
                            
                            confirmMessage += `This will replace all existing products. Continue with import?`;
                            
                            if (confirm(confirmMessage)) {
                                // Update products array
                                products = validProducts;
                                
                                // Save to localStorage
                                localStorage.setItem('sShopProducts', JSON.stringify(products));
                                
                                // Save to Firebase if available
                                if (window.FirebaseService) {
                                    FirebaseService.saveProducts(products)
                                        .then(() => {
                                            alert(`‚úÖ Successfully imported ${validProducts.length} products and saved to Firebase!`);
                                            displayProducts();
                                        })
                                        .catch(error => {
                                            console.error('Error saving to Firebase:', error);
                                            alert(`‚úÖ Products imported to localStorage (${validProducts.length} products).\n\n‚ö†Ô∏è Firebase save failed: ${error.message}`);
                                            displayProducts();
                                        });
                                } else {
                                    alert(`‚úÖ Successfully imported ${validProducts.length} products to localStorage!`);
                                    displayProducts();
                                }
                            }
                            
                        } catch (error) {
                            console.error('Error processing imported file:', error);
                            alert(`Error processing file: ${error.message}\n\nPlease check that your file contains valid JSON data.`);
                        }
                    };
                    
                    reader.onerror = function() {
                        alert('Error reading file. Please try again.');
                    };
                    
                    reader.readAsText(file);
                };
                
                input.click();
                
            } catch (error) {
                console.error('Error setting up file import:', error);
                alert('Error setting up file import. Please try again.');
            }
        }
    </script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>

</body>
</html> 