<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Chat Management - S Shop LK</title>
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="https://i.ibb.co/FqsbsjVB/S-shop-lk-logo.png">
    <link rel="shortcut icon" type="image/png" href="https://i.ibb.co/FqsbsjVB/S-shop-lk-logo.png">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* Dark blue background */
            color: #e2e8f0; /* Light gray text */
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b;
        }
        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 2px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        
        /* Message animations */
        .message-enter {
            animation: slideIn 0.2s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Unread indicator */
        .unread-indicator {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        /* Glassmorphism effect */
        .glass {
            background: rgba(30, 41, 59, 0.5); /* bg-slate-800/50 */
            backdrop-filter: blur(12px);
            border: 1px solid rgba(71, 85, 105, 0.5); /* border-slate-700/50 */
        }
        
        /* Hover effects */
        .hover-lift {
            transition: all 0.2s ease;
        }
        .hover-lift:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.1);
        }

        /* Message bubbles */
        .message-bubble {
            position: relative;
        }
        .message-admin {
            background-color: #dbeafe;
            margin-left: auto;
        }

        .message-user {
            background-color: #e5e7eb;
        }

        /* Prevent chat box from being pushed down */
        .chat-layout {
            height: calc(100vh - 200px);
            overflow: hidden;
        }
        
        .chat-input-area {
            flex-shrink: 0;
            border-top: 1px solid rgba(148, 163, 184, 0.1);
        }

        /* Loading animation */
        .loading-dots {
            display: inline-block;
        }

        .loading-dots::after {
            content: '';
            animation: dots 1.5s steps(5, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Header -->
    <header class="bg-slate-900/70 backdrop-blur-sm border-b border-slate-700 sticky top-0 z-50">
        <div class="container mx-auto px-4 py-2 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <div class="w-8 h-8 bg-blue-600/30 rounded-lg flex items-center justify-center border border-blue-500/50">
                    <svg class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                    </svg>
                </div>
                <span class="text-xl font-bold text-white">Chat Management</span>
            </div>
            <div class="flex items-center space-x-4">
                <span class="text-sm text-slate-400">Welcome, <span id="adminUsername" class="font-semibold text-white">Admin</span></span>
                <button onclick="logout()" class="bg-red-600/80 text-white px-3 py-1.5 rounded-lg font-semibold hover:bg-red-700/80 transition-colors text-xs">
                    Logout
                </button>
                <a href="index.html" class="text-slate-400 hover:text-white text-xs flex items-center space-x-1">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                    <span>Back to Website</span>
                </a>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="bg-slate-800/50 border-b border-slate-700">
        <div class="container mx-auto px-4">
            <div class="flex space-x-8 py-2">
                <a href="admin-dashboard.html" class="text-slate-400 hover:text-white py-2 px-1 text-sm font-medium">
                    Dashboard
                </a>
                <a href="admin.html" class="text-slate-400 hover:text-white py-2 px-1 text-sm font-medium">
                    Products
                </a>
                <a href="admin-chat.html" class="text-blue-400 border-b-2 border-blue-400 py-2 px-1 text-sm font-medium">
                    Chat
                </a>
                <a href="admin-logs.html" class="text-slate-400 hover:text-white py-2 px-1 text-sm font-medium">
                    Logs
                </a>
                <a href="admin-settings.html" class="text-slate-400 hover:text-white py-2 px-1 text-sm font-medium">
                    Settings
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6">
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 chat-layout">
            
            <!-- Left Sidebar - Chat List -->
            <div class="lg:col-span-1">
                <div class="glass rounded-xl p-4 h-full flex flex-col">
                    <div class="flex justify-between items-center mb-4 flex-shrink-0">
                        <h2 class="text-lg font-bold text-white">Conversations</h2>
                        <div class="flex space-x-1">
                            <button onclick="markAllAsRead()" class="bg-gradient-to-r from-green-500 to-green-600 text-white px-2 py-1 rounded-lg text-xs hover:from-green-600 hover:to-green-700 transition-all duration-200">
                                <svg class="w-3 h-3 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                Mark All Read
                            </button>
                        </div>
                    </div>
                    
                    <!-- Chat Stats -->
                    <div class="grid grid-cols-2 gap-3 mb-4 flex-shrink-0">
                        <div class="bg-slate-700/50 rounded-lg p-3 border border-slate-600">
                            <div class="text-xl font-bold text-blue-400" id="totalChats">0</div>
                            <div class="text-xs text-slate-400">Total Chats</div>
                        </div>
                        <div class="bg-slate-700/50 rounded-lg p-3 border border-slate-600">
                            <div class="text-xl font-bold text-red-500" id="unreadChats">0</div>
                            <div class="text-xs text-slate-400">Unread</div>
                        </div>
                    </div>
                    
                    <!-- Chat List -->
                    <div id="chatList" class="space-y-2 flex-1 overflow-y-auto">
                        <!-- Chats will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Right Side - Chat Messages -->
            <div class="lg:col-span-3">
                <div class="glass rounded-xl flex flex-col chat-layout">
                    
                    <!-- Chat Header -->
                    <div class="px-4 py-3 rounded-t-xl border-b border-slate-700/50 flex-shrink-0">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 bg-blue-600/30 rounded-full flex items-center justify-center border border-blue-500/50">
                                    <svg class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="text-base font-semibold text-white" id="currentChatUser">Select a chat</h3>
                                    <p class="text-xs text-slate-400" id="currentChatInfo">No chat selected</p>
                                </div>
                            </div>
                            <div id="chatActionButtons" class="flex space-x-2">
                                <button onclick="deleteChat()" class="bg-gradient-to-r from-red-500 to-red-600 text-white px-3 py-1 rounded-lg text-xs hover:from-red-600 hover:to-red-700 transition-all duration-200">
                                    <svg class="w-3 h-3 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                    Delete
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Messages Container -->
                    <div class="flex-1 overflow-y-auto p-4" id="messagesContainer">
                        <div class="text-center text-slate-500 py-8" id="noChatMessage">
                            <div class="w-16 h-16 bg-slate-700/50 rounded-full flex items-center justify-center mx-auto mb-3">
                                <svg class="w-8 h-8 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                            </svg>
                        </div>
                            <h3 class="text-base font-semibold text-slate-300 mb-1">No Chat Selected</h3>
                            <p class="text-slate-400 text-sm">Select a chat from the list to view messages</p>
                        </div>
                        
                        <!-- Messages will be loaded here -->
                        <div id="messagesList" class="space-y-3" style="display: none;">
                            <!-- Individual messages will be added here -->
                        </div>
                    </div>

                    <!-- Message Input -->
                    <div class="chat-input-area p-4 border-t border-slate-700/50" id="messageInputContainer" style="display: none;">
                        <form id="messageForm" class="flex space-x-3">
                            <div class="flex-1">
                                <textarea 
                                    id="messageInput" 
                                    placeholder="Type your message... Press Enter to send, Shift+Enter for new line" 
                                    class="w-full px-3 py-2 bg-slate-700/50 border border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none text-white placeholder-slate-400 text-sm"
                                    rows="2"
                                    maxlength="500"
                                ></textarea>
                                <div class="flex items-center justify-between mt-1 text-xs text-slate-400">
                                    <button type="button" id="quickReplyBtn" class="flex items-center space-x-1 text-blue-400 hover:text-blue-300 transition-colors">
                                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                                        <span>Quick Replies</span>
                                    </button>
                                    <span id="charCount">0/500</span>
                                </div>
                            </div>
                            <button 
                                type="submit" 
                                class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition-all duration-200 flex items-center space-x-2 text-sm"
                                id="sendButton"
                                title="Send message (Enter)"
                            >
                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                                </svg>
                                <span>Send</span>
                            </button>
                        </form>
                        <!-- Quick Replies Panel -->
                        <div id="quickReplyPanel" class="hidden absolute bottom-20 left-4 right-4 bg-slate-900/80 backdrop-blur-md border border-slate-700 rounded-lg p-4 shadow-2xl z-10">
                            <h4 class="text-sm font-semibold text-white mb-3">Select a Quick Reply</h4>
                            <div id="quickReplyList" class="grid grid-cols-1 sm:grid-cols-2 gap-2 max-h-48 overflow-y-auto">
                                <!-- Templates will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>

    <script>
        let currentChatId = null;
        let chats = [];
        let allChats = [];
        let currentChat = null;
        let quickReplyTemplates = [];
        let optimisticId = null; // Define at a higher scope
        let lastMessageCount = 0; // Track message count for real-time updates and notifications

        // Check authentication
        window.addEventListener('load', function() {
            checkAuth();
            setupChatListener(); // Set up the real-time listener
            loadChats();
            initializeQuickReplies();
            setupEventListeners();
            setupMessageNotifications();
        });

        // Set admin as offline when leaving the page
        window.addEventListener('beforeunload', function() {
            if (window.FirebaseService) {
                FirebaseService.setAdminOffline();
            }
        });

        // Notification functions (without sound)
        function showNotification(title, body) {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(title, {
                    body: body,
                    icon: 'https://i.ibb.co/FqsbsjVB/S-shop-lk-logo.png',
                    badge: 'https://i.ibb.co/FqsbsjVB/S-shop-lk-logo.png'
                });
            }
        }

        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }

        function setupMessageNotifications() {
            // Request notification permission on page load
            requestNotificationPermission();
            
            // Set up real-time listener for new messages only when needed
            if (window.FirebaseService && 
                typeof window.FirebaseService.onChatMessagesChange === 'function') {
                try {
                    console.log('Setting up Firebase message notifications...');
                    
                    // Only listen for changes when a chat is selected
                const unsubscribe = FirebaseService.onChatMessagesChange((chatId, messages) => {
                        // Validate parameters
                        if (!chatId || !messages || !Array.isArray(messages)) {
                            console.warn('Invalid parameters in chat messages callback:', { chatId, messages });
                            return;
                        }
                        
                        // Only update if this is the currently selected chat
                        if (chatId === currentChatId) {
                            const newMessages = messages.slice(lastMessageCount);
                            lastMessageCount = messages.length; // Update lastMessageCount
                            
                            // Display new messages immediately, but check for duplicates
                            newMessages.forEach(message => {
                                if (message && message.id) {
                                    // Only add if it's not the optimistic message we just sent
                                    if (!message.optimistic) addMessageIfNotExists(message, message.id);
                                }
                            });
                        
                        // Show browser notification for new messages
                        newMessages.forEach(message => {
                                if (message && message.sender !== 'admin') { // Only notify for user messages
                                // Show browser notification if not focused
                                if (!document.hasFocus()) {
                                    const chat = chats.find(c => c.id === chatId);
                                    const userName = chat ? generateUserName(chat.userId, chat.userName) : 'User';
                                    showNotification('New Message', `${userName}: ${message.text.substring(0, 50)}${message.text.length > 50 ? '...' : ''}`);
                                }
                            }
                        });
                    }
                });
                    
                    // Store unsubscribe function for cleanup
                    window.chatUnsubscribe = unsubscribe;
                
                // Cleanup on page unload
                window.addEventListener('beforeunload', () => {
                        if (window.chatUnsubscribe) {
                            window.chatUnsubscribe();
                        }
                    });
                    
                    console.log('Firebase message notifications setup complete');
                } catch (error) {
                    console.error('Error setting up message notifications:', error);
                }
            } else {
                console.warn('FirebaseService.onChatMessagesChange not available, skipping real-time updates');
            }
        }

        function checkAuth() {
            const username = sessionStorage.getItem('adminUsername');
            const loginTime = sessionStorage.getItem('adminLoginTime');
            
            if (!username || !loginTime) {
                window.location.href = 'admin-login.html';
                return;
            }
            
            // Check if session has expired (30 minutes)
            const now = Date.now();
            const loginTimeNum = parseInt(loginTime);
            if (now - loginTimeNum > 30 * 60 * 1000) {
                sessionStorage.clear();
                window.location.href = 'admin-login.html';
                return;
            }
            
            // Update display
            if (document.getElementById('adminUsername')) {
                document.getElementById('adminUsername').textContent = username;
            }
            
            // Set admin as online
            if (window.FirebaseService) {
                FirebaseService.setAdminOnline();
                // Log chat management access
                FirebaseService.logAdminAction('chat_management_accessed', {
                    username: username,
                    userAgent: navigator.userAgent
                });
            }
            
            startInactivityMonitoring();
        }

        function initializeQuickReplies() {
            // Define your quick reply templates here
            quickReplyTemplates = [
                { title: 'Greeting', text: 'Hello! Thank you for contacting S Shop LK support. How can I help you today?' },
                { title: 'Payment Info', text: 'We accept bank transfers and mobile payments. I can provide the details once you confirm your order.' },
                { title: 'Delivery Time', text: 'Digital products are delivered instantly or within a few hours. I will let you know the exact time for your specific order.' },
                { title: 'Product Availability', text: 'Let me check the availability of that product for you. One moment please.' },
                { title: 'Closing', text: 'Is there anything else I can help you with today?' },
                { title: 'Thank You', text: 'Thank you for choosing S Shop LK! Have a great day.' }
            ];

            const quickReplyList = document.getElementById('quickReplyList');
            quickReplyList.innerHTML = '';

            quickReplyTemplates.forEach(template => {
                const button = document.createElement('button');
                button.className = 'text-left p-3 bg-slate-700/50 hover:bg-slate-600/50 rounded-lg transition-colors text-sm';
                button.innerHTML = `
                    <p class="font-semibold text-white">${template.title}</p>
                    <p class="text-slate-400 truncate">${template.text}</p>
                `;
                button.onclick = () => {
                    const messageInput = document.getElementById('messageInput');
                    messageInput.value = template.text;
                    messageInput.focus();
                    updateCharCount();
                    document.getElementById('quickReplyPanel').classList.add('hidden');
                };
                quickReplyList.appendChild(button);
            });

            document.getElementById('quickReplyBtn').addEventListener('click', (e) => {
                e.stopPropagation();
                document.getElementById('quickReplyPanel').classList.toggle('hidden');
            });
        }

        function startInactivityMonitoring() {
            let inactivityTimer;
            const SESSION_TIMEOUT = 30 * 60 * 1000; // 30 minutes
            
            function resetInactivityTimer() {
                clearTimeout(inactivityTimer);
                inactivityTimer = setTimeout(function() {
                    sessionStorage.clear();
                    window.location.href = 'admin-login.html';
                }, SESSION_TIMEOUT);
            }
            
            // Reset timer on user activity
            document.addEventListener('mousemove', resetInactivityTimer);
            document.addEventListener('keypress', resetInactivityTimer);
            document.addEventListener('click', resetInactivityTimer);
            
            // Start the timer
            resetInactivityTimer();
        }

        function logout() {
            // Log admin logout from chat management
            if (window.FirebaseService) {
                FirebaseService.logAdminAction('chat_management_logout', {
                    username: sessionStorage.getItem('adminUsername'),
                    sessionDuration: Date.now() - parseInt(sessionStorage.getItem('adminLoginTime'))
                });
                FirebaseService.setAdminOffline();
            }
            
            sessionStorage.clear();
            window.location.href = 'admin-login.html';
        }

        // Fallback local storage functions for when Firebase is not available
        const LocalChatService = {
            async getChats() {
                try {
                    const storedChats = localStorage.getItem('adminChats');
                    return storedChats ? JSON.parse(storedChats) : [];
                } catch (error) {
                    console.error('Error loading chats from localStorage:', error);
                    return [];
                }
            },

            async getMessages(chatId) {
                try {
                    const storedMessages = localStorage.getItem(`adminMessages_${chatId}`);
                    return storedMessages ? JSON.parse(storedMessages) : [];
                } catch (error) {
                    console.error('Error loading messages from localStorage:', error);
                    return [];
                }
            },

            async sendMessage(chatId, messageText) {
                try {
                    const messages = await this.getMessages(chatId);
                    const newMessage = {
                        id: 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        text: messageText,
                        sender: 'admin',
                        userId: 'admin',
                        timestamp: new Date()
                    };
                    
                    messages.push(newMessage);
                    localStorage.setItem(`adminMessages_${chatId}`, JSON.stringify(messages));
                    
                    // Update chat's last message
                    const chats = await this.getChats();
                    const chatIndex = chats.findIndex(chat => chat.id === chatId);
                    if (chatIndex !== -1) {
                        chats[chatIndex].lastMessage = messageText;
                        chats[chatIndex].lastMessageAt = new Date();
                        chats[chatIndex].unreadCount = 0;
                        localStorage.setItem('adminChats', JSON.stringify(chats));
                    }
                    
                    return newMessage.id;
                } catch (error) {
                    console.error('Error sending message to localStorage:', error);
                    throw error;
                }
            },

            async updateChat(chatId, chatData) {
                try {
                    const chats = await this.getChats();
                    const chatIndex = chats.findIndex(chat => chat.id === chatId);
                    if (chatIndex !== -1) {
                        chats[chatIndex] = { ...chats[chatIndex], ...chatData };
                        localStorage.setItem('adminChats', JSON.stringify(chats));
                    }
                } catch (error) {
                    console.error('Error updating chat in localStorage:', error);
                    throw error;
                }
            }
        };

        async function loadChats() {
            try {
                const chatList = document.getElementById('chatList');
                chatList.innerHTML = `<div class="text-center text-gray-500 py-8">Loading chats...</div>`;

                console.log('Loading chats...');
                
                // Try Firebase first
                if (window.FirebaseService && window.FirebaseService.getChats) {
                    const firebaseChats = await FirebaseService.getChats();
                    
                    // Validate and filter chat data
                    chats = firebaseChats.filter(chat => {
                        if (!chat || !chat.id) {
                            console.warn('Filtering out invalid chat object:', chat);
                            return false;
                        }
                        return true;
                    });
                    
                    console.log('Loaded valid chats from Firebase:', chats.length);
                } else {
                    // Fallback to localStorage
                    console.log('Firebase not available, using localStorage fallback');
                    chats = await LocalChatService.getChats();
                    console.log('Loaded chats from localStorage:', chats.length);
                }
                
                displayChats();
                updateStats();
            } catch (error) {
                console.error('Error loading chats:', error);
                
                // Try localStorage as final fallback
                try {
                    console.log('Trying localStorage fallback...');
                    chats = await LocalChatService.getChats();
                    displayChats();
                    updateStats();
                } catch (fallbackError) {
                    console.error('LocalStorage fallback also failed:', fallbackError);
                    showError('Failed to load chats. Please check your connection.');
                
                // Show helpful error message
                const chatList = document.getElementById('chatList');
                chatList.innerHTML = `
                    <div class="text-center text-red-400 py-8">
                        <div class="w-16 h-16 bg-red-900/20 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z" />
                            </svg>
                        </div>
                            <p class="font-semibold mb-2 text-white">Connection Error</p>
                            <p class="text-sm text-slate-400">Unable to load chats. Please check your internet connection and try again.</p>
                    </div>
                `;
                }
            }
        }

        function setupChatListener() {
            if (window.FirebaseService && window.db) {
                db.collection('chats').onSnapshot(snapshot => {
                    snapshot.docChanges().forEach(change => {
                        const doc = change.doc;
                        const chat = doc.data();
                        if (chat && chat.userId) { // Basic validation
                            // Remove old version if it exists, then add the new/updated one
                            allChats = allChats.filter(c => c.id !== doc.id);
                            allChats.push({ id: doc.id, ...chat });
                        }
                    });
                    displayChats();
                    updateStats();
                }, error => {
                    console.error("Error with chat listener:", error);
                    showError("Real-time chat update failed. Please refresh.");
                });
            } else {
                console.warn("Firebase not available for real-time chat listener.");
            }
        }

        function displayChats() {
            const chatList = document.getElementById('chatList');
            chatList.innerHTML = '';

            if (chats.length === 0) {
                chatList.innerHTML = `
                    <div class="text-center text-slate-500 py-8">
                        <div class="w-16 h-16 bg-slate-700/50 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                            </svg>
                        </div>
                        <p class="text-slate-400">No active chats</p>
                    </div>
                `;
                return;
            }

            const chatsToDisplay = allChats.filter(chat => chat.status !== 'archived');

            // Sort by last message time, descending
            chatsToDisplay.sort((a, b) => (b.lastMessageAt?.toDate() || 0) - (a.lastMessageAt?.toDate() || 0));

            chatsToDisplay.forEach(chat => {
                // Skip invalid chat objects
                if (!chat || !chat.id) {
                    console.warn('Skipping invalid chat object:', chat);
                    return;
                }
                
                const chatElement = document.createElement('div');
                chatElement.className = `chat-item bg-slate-800/50 rounded-lg p-3 cursor-pointer transition-all duration-200 hover-lift ${chat.id === currentChatId ? 'ring-2 ring-blue-500 bg-slate-700' : 'border border-slate-700'}`;
                chatElement.dataset.chatId = chat.id; // Add data attribute for keyboard navigation
                chatElement.tabIndex = 0; // Make focusable for keyboard navigation
                
                const lastMessagePrefix = chat.lastMessageSender === 'admin' ? '<span class="text-slate-400">You: </span>' : '';
                const lastMessage = chat.lastMessage ? `${lastMessagePrefix}${chat.lastMessage}` : 'No messages yet';
                
                // Safely get time
                const time = formatRelativeTime(chat.lastMessageAt);
                
                const unreadCount = chat.unreadCount || 0;
                
                // Generate a proper user name based on user ID with error handling
                const userName = generateUserName(chat.userId, chat.userName);
                
                // Safely get user ID for display
                
                chatElement.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <div class="flex items-center space-x-2 mb-2">
                                <div class="w-8 h-8 bg-blue-600/30 border border-blue-500/50 rounded-full flex items-center justify-center flex-shrink-0">
                                    <svg class="w-4 h-4 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                    </svg>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center justify-between">
                                        <h4 class="font-semibold text-white text-sm truncate">${userName}</h4>
                                        <p class="text-xs text-slate-500 flex-shrink-0 ml-2">${time}</p>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <p class="text-xs text-slate-400 truncate">${lastMessage}</p>
                                        ${unreadCount > 0 ? `<span class="bg-red-500 text-white text-xs font-bold w-5 h-5 flex items-center justify-center rounded-full flex-shrink-0 ml-2">${unreadCount}</span>` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                chatElement.onclick = () => selectChat(chat);
                chatList.appendChild(chatElement);
            });
        }

        function formatRelativeTime(timestamp) {
            if (!timestamp) return '';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            const now = new Date();
            const diffSeconds = Math.round((now - date) / 1000);
            const diffDays = Math.floor(diffSeconds / 86400);

            if (diffSeconds < 60) return 'Just now';
            if (diffSeconds < 3600) return `${Math.floor(diffSeconds / 60)}m ago`;
            if (diffSeconds < 86400 && now.getDate() === date.getDate()) return date.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return date.toLocaleDateString([], { weekday: 'short' });
            return date.toLocaleDateString();
        }

        // Generate a proper user name based on user ID
        function generateUserName(userId, existingName) {
            // If there's an existing name from login, use it
            if (existingName && existingName !== 'Unknown User') {
                return existingName;
            }
            
            // Check if userId is valid
            if (!userId || typeof userId !== 'string') {
                return 'Unknown User';
            }
            
            // Fallback to generated name if no login name exists
            const hash = userId.split('').reduce((a, b) => {
                a = ((a << 5) - a) + b.charCodeAt(0);
                return a & a;
            }, 0);
            
            const names = [
                'Alex Johnson', 'Sarah Williams', 'Mike Chen', 'Emma Davis', 
                'David Brown', 'Lisa Garcia', 'James Wilson', 'Maria Rodriguez',
                'Robert Taylor', 'Jennifer Lee', 'Thomas Anderson', 'Amanda White',
                'Christopher Martinez', 'Nicole Thompson', 'Daniel Jackson', 'Rachel Moore',
                'Matthew Lewis', 'Jessica Clark', 'Anthony Hall', 'Michelle Young',
                'Kevin Allen', 'Stephanie King', 'Brian Wright', 'Ashley Green',
                'Steven Baker', 'Melissa Adams', 'Jason Nelson', 'Tiffany Carter',
                'Ryan Mitchell', 'Heather Perez', 'Gary Roberts', 'Christina Turner',
                'Timothy Phillips', 'Rebecca Campbell', 'Mark Parker', 'Laura Evans',
                'Jeffrey Edwards', 'Shannon Collins', 'Frank Stewart', 'Tracy Morris',
                'Raymond Rogers', 'Crystal Reed', 'Gregory Cook', 'Angela Morgan',
                'Benjamin Bell', 'Kimberly Murphy', 'Samuel Bailey', 'Deborah Rivera',
                'Patrick Cooper', 'Tara Richardson', 'Douglas Cox', 'Monica Ward',
                'Ronald Torres', 'Crystal Peterson', 'George Gray', 'Brenda James',
                'Edward Watson', 'Diana Brooks', 'Brian Kelly', 'Virginia Sanders',
                'Ronald Price', 'Carol Bennett', 'Timothy Wood', 'Pamela Barnes',
                'Kenneth Ross', 'Nicole Henderson', 'Stephen Coleman', 'Janet Jenkins',
                'Andrew Perry', 'Cheryl Powell', 'Joshua Long', 'Megan Patterson',
                'Kevin Hughes', 'Linda Hughes', 'Brian Flores', 'Donna Washington',
                'Ronald Butler', 'Barbara Simmons', 'Steven Foster', 'Helen Gonzales',
                'Eugene Bryant', 'Deborah Alexander', 'Russell Russell', 'Sharon Griffin',
                'Bobby Diaz', 'Cynthia Hayes', 'Victor Myers', 'Amy Ford', 'Martin Hamilton'
            ];
            
            const nameIndex = Math.abs(hash) % names.length;
            return names[nameIndex];
        }

        function updateStats() {
            document.getElementById('totalChats').textContent = chats.length;
            const unreadCount = chats.reduce((sum, chat) => sum + (chat.unreadCount || 0), 0);
            document.getElementById('unreadChats').textContent = unreadCount;
        }

        function clearChatSelection() {
            currentChatId = null;
            currentChat = null;
            document.getElementById('currentChatUser').textContent = 'Select a chat';
            document.getElementById('currentChatInfo').textContent = 'No chat selected';
            document.getElementById('messageInputContainer').style.display = 'none';

            const noChatMessage = document.getElementById('noChatMessage');
            const messagesList = document.getElementById('messagesList');
            if (noChatMessage) noChatMessage.classList.remove('hidden');
            if (messagesList) messagesList.classList.add('hidden');

            displayChats();
        }

        async function selectChat(chat) {
            // Check if chat object is valid
            if (!chat || !chat.id) {
                console.error('Invalid chat object:', chat);
                return;
            }
            
            currentChatId = chat.id;
            currentChat = chat;
            
            // Generate proper user name
            const userName = generateUserName(chat.userId, chat.userName);
            
            // Update UI with proper user name
            document.getElementById('currentChatUser').textContent = userName;
            
            // Safely get user ID for display
            const userEmail = chat.userEmail || 'No email provided';
            let lastActiveText = 'Never active';
            if (chat.lastMessageAt) {
                try {
                    const lastActive = chat.lastMessageAt.toDate ? chat.lastMessageAt.toDate() : new Date(chat.lastMessageAt);
                    lastActiveText = lastActive.toLocaleString();
                } catch (error) {
                    console.error('Error parsing last message time:', error);
                    lastActiveText = 'Unknown';
                }
            }
            
            document.getElementById('currentChatInfo').textContent = `${userEmail} • Last active: ${formatRelativeTime(chat.lastMessageAt, true)}`;

            document.getElementById('messageInputContainer').style.display = 'block';
            
            // Load messages
            await loadMessages();
            
            // Mark as read
            if (chat.unreadCount > 0) {
                await markChatAsRead(chat.id);
            }
            
            // Update chat list display
            displayChats();
        }

        async function loadMessages() {
            if (!currentChatId) return;

            const messagesContainer = document.getElementById('messagesContainer');
            const messagesList = document.getElementById('messagesList');
            const noChatMessage = document.getElementById('noChatMessage');

            // Show messages container and hide no chat message
            messagesList.style.display = 'block';
            noChatMessage.style.display = 'none';
            messagesList.innerHTML = ''; // Clear previous messages

            try {
                let lastMessageDate = null;
                let messages;
                
                // Try Firebase first with timeout
                if (window.FirebaseService && window.FirebaseService.getMessages) {
                    const firebasePromise = FirebaseService.getMessages(currentChatId);
                    const timeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Firebase timeout')), 3000)
                    );
                    
                    try {
                        messages = await Promise.race([firebasePromise, timeoutPromise]);
                    } catch (timeoutError) {
                        console.warn('Firebase timeout, using localStorage fallback');
                        messages = await LocalChatService.getMessages(currentChatId);
                    }
                } else {
                    // Fallback to localStorage
                    messages = await LocalChatService.getMessages(currentChatId);
                }
                
                // Reset message count for real-time updates
                lastMessageCount = messages.length;
                
                // Display all messages efficiently
                const fragment = document.createDocumentFragment();
                messages.forEach(message => {
                    const messageTimestamp = message.timestamp?.toDate ? message.timestamp.toDate() : new Date(message.timestamp);
                    const messageDate = new Date(messageTimestamp.getFullYear(), messageTimestamp.getMonth(), messageTimestamp.getDate());
                    
                    // Check if we need to add a date separator
                    if (!lastMessageDate || messageDate.toDateString() !== lastMessageDate.toDateString()) {
                        fragment.appendChild(createDateSeparator(messageDate));
                        lastMessageDate = messageDate;
                    }

                    const messageDiv = createMessageElement(message, message.id, messageTimestamp);
                    fragment.appendChild(messageDiv);
                });
                
                messagesList.appendChild(fragment);
                
                // Scroll to bottom after loading all messages
                setTimeout(() => {
                    scrollToBottomInstant();
                }, 50); // Reduced timeout for faster response
                
            } catch (error) {
                console.error('Error loading messages:', error);
                messagesList.innerHTML = '<div class="text-center text-red-400 py-8">Failed to load messages</div>';
            }
        }

        function createMessageElement(messageData, messageId, messageTimestamp) {
            const isAdmin = messageData.sender === 'admin';
            const avatarIcon = isAdmin 
                ? `<svg class="w-4 h-4 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6-4a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>` // Checkmark for admin
                : `<svg class="w-4 h-4 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>`;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${isAdmin ? 'justify-end' : 'justify-start'} mb-4 message-enter`;
            messageDiv.id = `message-${messageId}`;
            
            const time = messageTimestamp ? messageTimestamp.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' }) : 'Just now';
            
            messageDiv.innerHTML = `
                <div class="flex items-end space-x-2 max-w-xs lg:max-w-md ${isAdmin ? 'flex-row-reverse space-x-reverse' : ''}">
                    <div class="w-8 h-8 ${isAdmin ? 'bg-green-600' : 'bg-blue-600'} rounded-full flex items-center justify-center flex-shrink-0 shadow-md">
                        ${avatarIcon}
                    </div>
                    <div class="message-bubble rounded-xl p-3 shadow-md ${isAdmin ? 'bg-blue-600 text-white' : 'bg-slate-700 text-slate-200'}">
                        <p class="text-sm">${messageData.text}</p>
                        <p class="text-xs ${isAdmin ? 'text-blue-200' : 'text-slate-400'} opacity-75 mt-1 text-right">${isAdmin ? 'You' : 'User'} • ${time}</p>
                    </div>
                </div>
            `;
            
            return messageDiv;
        }

        function createDateSeparator(date) {
            const separatorDiv = document.createElement('div');
            separatorDiv.className = 'flex items-center justify-center my-4';
            separatorDiv.innerHTML = `
                <div class="flex-grow border-t border-slate-700"></div>
                <span class="flex-shrink mx-4 text-xs text-slate-400 font-semibold">
                    ${formatDateSeparator(date)}
                </span>
                <div class="flex-grow border-t border-slate-700"></div>
            `;
            return separatorDiv;
        }

        function formatDateSeparator(date) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const yesterday = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1);
            
            if (date.toDateString() === today.toDateString()) return 'Today';
            if (date.toDateString() === yesterday.toDateString()) return 'Yesterday';
            
            return date.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        }

        function displayMessage(messageData, messageId) {
            const messagesList = document.getElementById('messagesList');
            
            // Check if message already exists to prevent duplicates
            const existingMessage = document.getElementById(`message-${messageId}`);
            if (existingMessage) {
                console.log('Message already exists, skipping duplicate:', messageId);
                return;
            }
            
            const messageTimestamp = messageData.timestamp?.toDate ? messageData.timestamp.toDate() : new Date(messageData.timestamp);
            const messageDate = new Date(messageTimestamp.getFullYear(), messageTimestamp.getMonth(), messageTimestamp.getDate());
            
            // Check if a date separator is needed before adding the message
            const lastMessageElement = messagesList.lastElementChild;
            if (lastMessageElement && lastMessageElement.dataset.messageDate) {
                const lastDate = new Date(lastMessageElement.dataset.messageDate);
                if (messageDate.toDateString() !== lastDate.toDateString()) {
                    messagesList.appendChild(createDateSeparator(messageDate));
                }
            }
            const messageDiv = createMessageElement(messageData, messageId, messageTimestamp);
            messagesList.appendChild(messageDiv);
            
            // Auto-scroll to bottom for new messages with reduced delay
            setTimeout(() => {
                scrollToBottomInstant();
            }, 50); // Reduced from 100ms to 50ms
        }

        function addMessageIfNotExists(messageData, messageId) {
            const existingMessage = document.getElementById(`message-${messageId}`);
            if (!existingMessage) {
                displayMessage(messageData, messageId);
                return true; // Message was added
            }
            return false; // Message already exists
        }

        function setupEventListeners() {
            const messageForm = document.getElementById('messageForm');
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            const charCount = document.getElementById('charCount');

            messageForm.addEventListener('submit', function(e) {
                e.preventDefault();
                sendMessage();
            });

            // Auto-resize textarea
            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
                updateCharCount();
            });

            document.body.addEventListener('click', function() {
                document.getElementById('quickReplyPanel').classList.add('hidden');
            });

            document.getElementById('quickReplyPanel').addEventListener('click', (e) => {
                e.stopPropagation();
            });

            // Keyboard shortcuts
            setupKeyboardShortcuts();
            updateCharCount(); // Initial call to set char count
        }

        function updateCharCount() {
            const messageInput = document.getElementById('messageInput');
            const charCount = document.getElementById('charCount');
            if (charCount) {
                charCount.textContent = `${messageInput.value.length}/500`;
            }
        }

        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                // Don't trigger shortcuts when typing in input fields
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                    return;
                }

                // Ctrl/Cmd + Enter: Send message (when message input is focused)
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    const messageInput = document.getElementById('messageInput');
                    if (document.activeElement === messageInput) {
                        e.preventDefault();
                        sendMessage();
                    }
                }

                // Escape: Clear selection or close modals
                if (e.key === 'Escape') {
                    e.preventDefault();
                    clearChatSelection();
                }

                // Ctrl/Cmd + R: Refresh chats
                if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
                    e.preventDefault();
                    loadChats(); // Changed from refreshChats
                }

                // Ctrl/Cmd + A: Mark all as read
                if ((e.ctrlKey || e.metaKey) && e.key === 'a') {
                    e.preventDefault();
                    markAllAsRead();
                }

                // Arrow keys for chat navigation
                if (e.key === 'ArrowUp' || e.key === 'ArrowDown') {
                    e.preventDefault();
                    navigateChats(e.key === 'ArrowUp' ? -1 : 1);
                }

                // Enter: Select focused chat
                if (e.key === 'Enter') {
                    const focusedChat = document.querySelector('#chatList .chat-item:focus');
                    if (focusedChat) {
                        e.preventDefault();
                        const chatId = focusedChat.dataset.chatId;
                        const chat = chats.find(c => c.id === chatId);
                        if (chat) {
                            selectChat(chat);
                        }
                    }
                }

                // Number keys 1-9: Quick select chats
                if (e.key >= '1' && e.key <= '9') {
                    e.preventDefault();
                    const chatIndex = parseInt(e.key) - 1;
                    if (chatIndex < chats.length) {
                        selectChat(chats[chatIndex]);
                    }
                }

                // Ctrl/Cmd + Delete: Delete current chat
                if ((e.ctrlKey || e.metaKey) && e.key === 'Delete') {
                    e.preventDefault();
                    if (currentChatId) {
                        deleteChat();
                    }
                }

                // Ctrl/Cmd + S: Archive current chat
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    if (currentChatId) {
                        archiveChat();
                    }
                }

                // F5: Refresh page
                if (e.key === 'F5') {
                    e.preventDefault();
                    location.reload();
                }

                // Ctrl/Cmd + L: Logout
                if ((e.ctrlKey || e.metaKey) && e.key === 'l') {
                    e.preventDefault();
                    logout();
                }

                // Ctrl/Cmd + B: Back to admin panel
                if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
                    e.preventDefault();
                    window.location.href = 'admin-dashboard.html'; // Changed to dashboard for consistency
                }
            });

            // Focus management for chat list
            const chatList = document.getElementById('chatList');
            chatList.addEventListener('keydown', function(e) {
                const chatItems = chatList.querySelectorAll('.chat-item');
                const currentIndex = Array.from(chatItems).findIndex(item => item === document.activeElement);

                switch (e.key) {
                    case 'ArrowUp':
                        e.preventDefault();
                        if (currentIndex > 0) {
                            chatItems[currentIndex - 1].focus();
                        }
                        break;
                    case 'ArrowDown':
                        e.preventDefault();
                        if (currentIndex < chatItems.length - 1) {
                            chatItems[currentIndex + 1].focus();
                        }
                        break;
                    case 'Home':
                        e.preventDefault();
                        if (chatItems.length > 0) {
                            chatItems[0].focus();
                        }
                        break;
                    case 'End':
                        e.preventDefault();
                        if (chatItems.length > 0) {
                            chatItems[chatItems.length - 1].focus();
                        }
                        break;
                }
            });
        }

        function navigateChats(direction) {
            const chatItems = document.querySelectorAll('#chatList .chat-item');
            const currentIndex = Array.from(chatItems).findIndex(item => 
                item.classList.contains('ring-2') || item === document.activeElement
            );

            let newIndex;
            if (direction === -1) {
                newIndex = currentIndex > 0 ? currentIndex - 1 : chatItems.length - 1;
            } else {
                newIndex = currentIndex < chatItems.length - 1 ? currentIndex + 1 : 0;
            }

            if (chatItems[newIndex]) {
                chatItems[newIndex].focus();
                const chatId = chatItems[newIndex].dataset.chatId;
                const chat = chats.find(c => c.id === chatId);
                if (chat) {
                    selectChat(chat);
                }
            }
        }

        function clearChatSelection() {
            currentChatId = null;
            currentChat = null;
            document.getElementById('currentChatUser').textContent = 'Select a chat';
            document.getElementById('currentChatInfo').textContent = 'No chat selected';
            document.getElementById('messageInputContainer').style.display = 'none';
            document.getElementById('messagesContainer').innerHTML = `
                <div class="text-center text-slate-500 py-12">
                    <div class="w-20 h-20 bg-gradient-to-r from-slate-600 to-slate-700 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-10 h-10 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                        </svg>
                    </div>
                    <h3 class="text-lg font-semibold text-slate-300 mb-2">No Chat Selected</h3>
                    <p class="text-slate-500">Select a chat from the list to view messages</p>
                </div>
            `;
            displayChats();
        }

        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message || !currentChatId) return;

            try {
                // Clear input immediately
                messageInput.value = '';
                messageInput.style.height = 'auto';
                updateCharCount();
                
                // Create optimistic message display (show immediately) - optimisticId is now defined at a higher scope
                optimisticId = 'temp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                const optimisticMessage = {
                    id: optimisticId,
                    text: message,
                    sender: 'admin',
                    sender: 'admin',
                    userId: 'admin',
                    timestamp: new Date()
                };

                // Ensure the message list is visible before adding a message
                const messagesList = document.getElementById('messagesList');
                const noChatMessage = document.getElementById('noChatMessage');
                if (messagesList && messagesList.classList.contains('hidden')) {
                    messagesList.classList.remove('hidden');
                    if (noChatMessage) noChatMessage.classList.add('hidden');
                }
                // Display message immediately for better UX
                displayMessage(optimisticMessage, optimisticId);
                
                let messageId;
                
                // Try Firebase first with timeout
                if (window.FirebaseService && window.FirebaseService.sendMessage) { 
                    // Update the chat's last message sender
                    await FirebaseService.updateChat(currentChatId, { lastMessageSender: 'admin' });

                    const firebasePromise = FirebaseService.addMessage(currentChatId, { text: message, sender: 'admin', userId: 'admin' });
                    const timeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Firebase timeout')), 5000)
                    );
                    
                    try {
                        messageId = await Promise.race([firebasePromise, timeoutPromise]);
                        
                        // Update the chat's last message and timestamp
                        await FirebaseService.updateChat(currentChatId, {
                            lastMessage: message,
                            lastMessageAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        // Log admin action
                        if (window.FirebaseService.logAdminAction) {
                            FirebaseService.logAdminAction('message_sent', {
                                chatId: currentChatId,
                                messageLength: message.length,
                                adminEmail: sessionStorage.getItem('adminEmail')
                            });
                        }
                        
                        // Update the optimistic message with real ID and remove temp styling
                        const tempMessage = document.getElementById(`message-${optimisticId}`);
                        if (tempMessage) {
                            tempMessage.id = `message-${messageId}`;
                            // Remove any temporary styling if needed
                            tempMessage.classList.remove('temp-message');
                        }
                        
                        // Update message count to prevent duplicate from real-time listener
                        lastMessageCount++;
                        
                    } catch (timeoutError) {
                        console.warn('Firebase timeout, using localStorage fallback');
                        messageId = await LocalChatService.addMessage(currentChatId, message);
                        
                        // Update the optimistic message with localStorage ID
                        const tempMessage = document.getElementById(`message-${optimisticId}`);
                        if (tempMessage) {
                            tempMessage.id = `message-${messageId}`;
                        }
                    }
                } else {
                    // Fallback to localStorage
                    messageId = await LocalChatService.addMessage(currentChatId, message);
                    
                    // Update the optimistic message with localStorage ID
                    const tempMessage = document.getElementById(`message-${optimisticId}`);
                    if (tempMessage) {
                        tempMessage.id = `message-${messageId}`;
                    }
                }
                
                // Scroll to bottom after sending with minimal delay
                setTimeout(() => {
                    scrollToBottomInstant();
                }, 10); // Minimal delay for immediate response

            } catch (error) {
                console.error('Error sending message:', error);
                showError('Failed to send message: ' + error.message);
                // Restore message if failed
                messageInput.value = message;
                updateCharCount();
                
                // Remove optimistic message if it exists and optimisticId is set
                const tempMessage = document.getElementById(`message-${optimisticId}`);
                if (tempMessage) {
                    tempMessage.remove();
                }
            }
        }

        async function markChatAsRead(chatId) {
            try {
                // Try Firebase first
                if (window.FirebaseService && window.FirebaseService.updateChat) {
                await FirebaseService.updateChat(chatId, {
                    unreadCount: 0
                });
                } else {
                    // Fallback to localStorage
                    await LocalChatService.updateChat(chatId, {
                        unreadCount: 0
                    });
                }
                
                // Update local chat data
                const chatIndex = chats.findIndex(chat => chat.id === chatId);
                if (chatIndex !== -1) {
                    chats[chatIndex].unreadCount = 0;
                }
            } catch (error) {
                console.error('Error marking chat as read:', error);
            }
        }

        async function markAllAsRead() {
            try {
                const batch = db.batch();
                chats.forEach(chat => {
                    if (chat.unreadCount > 0) {
                        const ref = db.collection('chats').doc(chat.id);
                        batch.update(ref, { unreadCount: 0 });
                    }
                });
                await batch.commit();
                
                // Update local data
                chats.forEach(chat => chat.unreadCount = 0);
                displayChats();
                updateStats();
            } catch (error) {
                console.error('Error marking all as read:', error);
                showError('Failed to mark all as read');
            }
        }

        async function deleteChat() {
            if (!currentChatId) return;
            
            if (confirm('Are you sure you want to delete this chat? This action cannot be undone.')) {
                try {
                    // Delete all messages first
                    const messagesSnapshot = await db.collection('chats').doc(currentChatId)
                        .collection('messages').get();
                    
                    const batch = db.batch();
                    messagesSnapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();
                    
                    // Delete the chat document
                    await FirebaseService.deleteChat(currentChatId);
                    
                    // Remove from local list
                    chats = chats.filter(chat => chat.id !== currentChatId);
                    allChats = allChats.filter(chat => chat.id !== currentChatId);
                    updateStats();
                    
                    // Clear current chat
                    currentChatId = null;
                    currentChat = null;
                    document.getElementById('currentChatUser').textContent = 'Select a chat';
                    document.getElementById('currentChatInfo').textContent = 'No chat selected';
                    document.getElementById('messageInputContainer').style.display = 'none';
                    document.getElementById('messagesContainer').innerHTML = `
                        <div class="text-center text-slate-500 py-12">
                            <div class="w-20 h-20 bg-gradient-to-r from-slate-600 to-slate-700 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg class="w-10 h-10 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                                </svg>
                            </div>
                            <h3 class="text-lg font-semibold text-slate-300 mb-2">No Chat Selected</h3>
                            <p class="text-slate-500">Select a chat from the list to view messages</p>
                        </div>
                    `;
                    updateStats();
                    displayChats();
                } catch (error) {
                    console.error('Error deleting chat:', error);
                    showError('Failed to delete chat');
                }
            }
        }

        function scrollToBottom() {
            const messagesContainer = document.getElementById('messagesContainer');
            const messagesList = document.getElementById('messagesList');
            
            // Scroll to bottom with smooth animation
            messagesContainer.scrollTo({
                top: messagesContainer.scrollHeight,
                behavior: 'smooth'
            });
        }

        function scrollToBottomInstant() {
            const messagesContainer = document.getElementById('messagesContainer');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showKeyboardShortcuts() {
            const shortcutsModal = document.createElement('div');
            shortcutsModal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4';
            shortcutsModal.innerHTML = `
                <div class="bg-slate-800 rounded-2xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto glass border border-slate-600">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-white">Keyboard Shortcuts</h3>
                        <button onclick="closeKeyboardShortcuts()" class="text-slate-400 hover:text-white transition-colors">
                            <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div class="space-y-3">
                            <h4 class="text-lg font-semibold text-blue-400 mb-3">Navigation & Selection</h4>
                            <div class="space-y-2">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-2">
                                        <kbd class="bg-slate-700 px-2 py-1 rounded text-xs font-mono">↑</kbd>
                                        <kbd class="bg-slate-700 px-2 py-1 rounded text-xs font-mono">↓</kbd>
                                    </div>
                                    <span class="text-slate-300">Navigate chat list</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <kbd class="bg-slate-700 px-2 py-1 rounded text-xs font-mono">Enter</kbd>
                                    <span class="text-slate-300">Select focused chat</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <kbd class="bg-slate-700 px-2 py-1 rounded text-xs font-mono">1-9</kbd>
                                    <span class="text-slate-300">Quick select chats</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <kbd class="bg-slate-700 px-2 py-1 rounded text-xs font-mono">Esc</kbd>
                                    <span class="text-slate-300">Clear selection</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="space-y-3">
                            <h4 class="text-lg font-semibold text-green-400 mb-3">Chat Management</h4>
                            <div class="space-y-2">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-1">
                                        <kbd class="bg-slate-700 px-2 py-1 rounded text-xs font-mono">Ctrl</kbd>
                                        <span class="text-slate-400">+</span>
                                        <kbd class="bg-slate-700 px-2 py-1 rounded text-xs font-mono">R</kbd>
                                    </div>
                                    <span class="text-slate-300">Refresh chats</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-1">
                                        <kbd class="bg-slate-700 px-2 py-1 rounded text-xs font-mono">Ctrl</kbd>
                                        <span class="text-slate-400">+</span>
                                        <kbd class="bg-slate-700 px-2 py-1 rounded text-xs font-mono">A</kbd>
                                    </div>
                                    <span class="text-slate-300">Mark all as read</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-1">
                                        <kbd class="bg-slate-700 px-2 py-1 rounded text-xs font-mono">Ctrl</kbd>
                                        <span class="text-slate-400">+</span>
                                        <kbd class="bg-slate-700 px-2 py-1 rounded text-xs font-mono">S</kbd>
                                    </div>
                                    <span class="text-slate-300">Archive chat</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-1">
                                        <kbd class="bg-slate-700 px-2 py-1 rounded text-xs font-mono">Ctrl</kbd>
                                        <span class="text-slate-400">+</span>
                                        <kbd class="bg-slate-700 px-2 py-1 rounded text-xs font-mono">Del</kbd>
                                    </div>
                                    <span class="text-slate-300">Delete chat</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="space-y-3">
                            <h4 class="text-lg font-semibold text-purple-400 mb-3">Messaging</h4>
                            <div class="space-y-2">
                                <div class="flex items-center justify-between">
                                    <kbd class="bg-slate-700 px-2 py-1 rounded text-xs font-mono">Enter</kbd>
                                    <span class="text-slate-300">Send message</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-1">
                                        <kbd class="bg-slate-700 px-2 py-1 rounded text-xs font-mono">Shift</kbd>
                                        <span class="text-slate-400">+</span>
                                        <kbd class="bg-slate-700 px-2 py-1 rounded text-xs font-mono">Enter</kbd>
                                    </div>
                                    <span class="text-slate-300">New line</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-1">
                                        <kbd class="bg-slate-700 px-2 py-1 rounded text-xs font-mono">Ctrl</kbd>
                                        <span class="text-slate-400">+</span>
                                        <kbd class="bg-slate-700 px-2 py-1 rounded text-xs font-mono">Enter</kbd>
                                    </div>
                                    <span class="text-slate-300">Send message (alternative)</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="space-y-3">
                            <h4 class="text-lg font-semibold text-red-400 mb-3">System</h4>
                            <div class="space-y-2">
                                <div class="flex items-center justify-between">
                                    <kbd class="bg-slate-700 px-2 py-1 rounded text-xs font-mono">F5</kbd>
                                    <span class="text-slate-300">Refresh page</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-1">
                                        <kbd class="bg-slate-700 px-2 py-1 rounded text-xs font-mono">Ctrl</kbd>
                                        <span class="text-slate-400">+</span>
                                        <kbd class="bg-slate-700 px-2 py-1 rounded text-xs font-mono">L</kbd>
                                    </div>
                                    <span class="text-slate-300">Logout</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-1">
                                        <kbd class="bg-slate-700 px-2 py-1 rounded text-xs font-mono">Ctrl</kbd>
                                        <span class="text-slate-400">+</span>
                                        <kbd class="bg-slate-700 px-2 py-1 rounded text-xs font-mono">B</kbd>
                                    </div>
                                    <span class="text-slate-300">Back to admin</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6 pt-4 border-t border-slate-600">
                        <p class="text-xs text-slate-400 text-center">
                            Tip: Use Tab to navigate between chat items, then Enter to select
                        </p>
                    </div>
                </div>
            `;
            
            // Close modal when clicking outside
            shortcutsModal.addEventListener('click', function(e) {
                if (e.target === shortcutsModal) {
                    closeKeyboardShortcuts();
                }
            });
            
            // Close modal with Escape key
            document.addEventListener('keydown', function closeOnEscape(e) {
                if (e.key === 'Escape') {
                    closeKeyboardShortcuts();
                    document.removeEventListener('keydown', closeOnEscape);
                }
            });
            
            document.body.appendChild(shortcutsModal);
        }

        function closeKeyboardShortcuts() {
            const modal = document.querySelector('.fixed.inset-0.bg-black.bg-opacity-75');
            if (modal) {
                document.body.removeChild(modal);
            }
        }

        function showError(message) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-gradient-to-r from-red-500 to-red-600 text-white px-6 py-3 rounded-xl shadow-lg z-50 flex items-center space-x-2';
            notification.innerHTML = `
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z" />
                </svg>
                <span>${message}</span>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }
    </script>

</body>
</html> 
