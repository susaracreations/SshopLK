<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Details - S Shop LK</title>
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="https://i.ibb.co/FqsbsjVB/S-shop-lk-logo.png">
    <link rel="shortcut icon" type="image/png" href="https://i.ibb.co/FqsbsjVB/S-shop-lk-logo.png">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #3b82f6;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- Header Container -->
    <div id="header-container"></div>

    <!-- Breadcrumbs -->
    <div class="bg-slate-800 border-b border-slate-700">
        <div class="container mx-auto px-4 py-3">
            <nav class="flex" aria-label="Breadcrumb">
                <ol id="breadcrumbs" class="flex items-center space-x-2 text-sm text-gray-400">
                    <li><a href="index.html" class="hover:text-white transition-colors">Home</a></li>
                    <li class="flex items-center">
                        <svg class="w-4 h-4 mx-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                        </svg>
                        <a id="breadcrumb-category" href="#" class="hover:text-white transition-colors">Category</a>
                    </li>
                    <li class="flex items-center">
                        <svg class="w-4 h-4 mx-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                        </svg>
                        <span id="breadcrumb-product-name" class="text-white">Product</span>
                    </li>
                </ol>
            </nav>
        </div>
    </div>

    <!-- Main Content -->
    <main class="flex-grow container mx-auto px-4 py-8 md:py-12">
        <div id="product-detail-container" class="max-w-4xl mx-auto">
            <!-- Loading State -->
            <div id="loading-state" class="text-center py-16">
                <div class="loading-spinner mx-auto"></div>
                <p class="mt-4 text-lg text-gray-300">Loading Product Details...</p>
            </div>

            <!-- Error State -->
            <div id="error-state" class="hidden text-center py-16 bg-red-900/20 border border-red-500/50 rounded-lg">
                <h2 class="text-2xl font-bold text-red-400 mb-4">Product Not Found</h2>
                <p class="text-gray-300 mb-6">Sorry, we couldn't find the product you're looking for.</p>
                <a href="index.html" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                    Back to Home
                </a>
            </div>

            <!-- Content -->
            <div id="product-content" class="hidden grid grid-cols-1 md:grid-cols-2 gap-8 md:gap-12">
                <!-- Product Image -->
                <div>
                    <img id="product-image" src="" alt="Product Image" class="w-full h-auto object-cover rounded-xl shadow-lg border border-slate-700">
                </div>

                <!-- Product Info -->
                <div class="flex flex-col">
                    <!-- Trust Badge -->
                    <div id="trust-badge-container" class="hidden mb-4">
                        <div class="bg-green-500/10 border border-green-500/30 text-green-300 text-xs font-bold uppercase px-3 py-1.5 rounded-full inline-flex items-center space-x-2">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944a11.954 11.954 0 007.834 3.055l-1.966-1.966A9.955 9.955 0 0110 3.944a9.955 9.955 0 01-5.868 1.966l-1.966 1.966z" clip-rule="evenodd"></path><path d="M12.5 11a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path><path fill-rule="evenodd" d="M.666 10.585A12.034 12.034 0 0110 5.944a12.034 12.034 0 019.334 4.641l-1.966 1.966A9.955 9.955 0 0010 7.944a9.955 9.955 0 00-7.368 3.572l-1.966-1.931z" clip-rule="evenodd"></path></svg>
                            <span id="trust-badge-text"></span>
                        </div>
                    </div>

                    <h1 id="product-name" class="text-3xl md:text-4xl font-bold text-white mb-4"></h1>
                    <p id="product-description" class="text-gray-300 leading-relaxed mb-6"></p>

                    <!-- Key Details -->
                    <div class="bg-slate-800/50 border border-slate-700 rounded-lg p-4 mb-6">
                        <h3 class="text-lg font-semibold text-white mb-4">Product Specifications</h3>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div id="availability-container" class="hidden"><strong class="text-gray-400 block">Availability:</strong> <span id="product-availability" class="text-white"></span></div>
                            <div id="category-container" class="hidden"><strong class="text-gray-400 block">Category:</strong> <span id="product-category" class="text-white"></span></div>
                            <div id="delivery-speed-container" class="hidden"><strong class="text-gray-400 block">Delivery Speed:</strong> <span id="product-delivery-speed" class="text-white"></span></div>
                            <div id="delivery-method-container" class="hidden"><strong class="text-gray-400 block">Delivery Method:</strong> <span id="product-delivery-method" class="text-white"></span></div>
                            <div id="activation-region-container" class="hidden"><strong class="text-gray-400 block">Activation Region:</strong> <span id="product-activation-region" class="text-white"></span></div>
                        </div>
                    </div>

                    <div class="mt-auto">
                        <div class="flex items-center justify-between bg-slate-800 p-4 rounded-lg border border-slate-700 mb-6">
                            <span class="text-3xl font-extrabold text-blue-400" id="product-price"></span>
                            <div class="text-right">
                                <span id="product-sold" class="text-sm text-gray-400 block"></span>
                                <div id="other-sellers-container" class="hidden">
                                    <span class="text-xs text-gray-500"><span id="product-other-sellers"></span> other sellers</span>
                                </div>
                            </div>
                        </div>
                        <button id="buy-now-button" class="w-full bg-blue-600 text-white py-4 rounded-lg font-semibold text-lg hover:bg-blue-700 transition-colors duration-300">
                            Buy Now
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Related Products Section -->
        <section id="related-products-section" class="hidden max-w-4xl mx-auto mt-12 md:mt-16">
            <h2 class="text-2xl font-bold text-white mb-6">Related Products</h2>
            <div id="related-products-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Related product cards will be injected here -->
            </div>
        </section>

    </main>

    <!-- Footer Container -->
    <div id="footer-container"></div>

    <!-- Buy Now Modal -->
    <div id="buyNowModal" class="fixed inset-0 bg-gray-950 bg-opacity-75 flex items-center justify-center z-[1000] p-4 hidden">
        <div class="bg-gray-800 rounded-lg shadow-2xl p-6 md:p-8 w-full max-w-sm text-center border-2 border-blue-600 relative">
            <!-- Close Button -->
            <button class="absolute top-4 right-4 text-gray-400 hover:text-white" onclick="closeModal()">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>

            <h3 class="text-2xl font-bold mb-2 text-white" id="modalTitle">How would you like to buy?</h3>
            <p class="text-gray-400 mb-6" id="modalDescription">Contact a seller to complete your purchase of "<span id="productNameInModal" class="font-semibold text-white">Product Name</span>".</p>
            
            <div class="flex flex-col space-y-4">
                <!-- WhatsApp Button -->
                <a href="#" id="whatsappLink" class="flex items-center justify-center space-x-2 bg-green-500 text-white py-3 rounded-lg font-semibold hover:bg-green-600 transition-colors duration-300">
                    <img src="https://image.similarpng.com/file/similarpng/original-picture/2021/01/Whatsapp-icon-with-black-color-on-transparent-background-PNG.png" alt="WhatsApp Icon" class="h-6 w-6">
                    <span>Buy on WhatsApp</span>
                </a>

                <!-- Discord Button -->
                <a href="#" id="discordLink" class="flex items-center justify-center space-x-2 bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors duration-300">
                    <img src="https://uxwing.com/wp-content/themes/uxwing/download/brands-and-social-media/discord-round-black-icon.png" alt="Discord Icon" class="h-6 w-6">
                    <span>Buy on Discord</span>
                </a>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>

    <!-- Shared Components -->
    <script src="header-component.js"></script>
    <script src="footer-component.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            loadProductDetails();
        });

        async function loadProductDetails() {
            const loadingState = document.getElementById('loading-state');
            const errorState = document.getElementById('error-state');
            const productContent = document.getElementById('product-content');

            const params = new URLSearchParams(window.location.search);
            const productId = params.get('id');

            if (!productId) {
                loadingState.classList.add('hidden');
                errorState.classList.remove('hidden');
                return;
            }

            try {
                // Wait for Firebase to be ready
                await new Promise(resolve => {
                    const checkFirebase = () => {
                        if (window.FirebaseService) {
                            resolve();
                        } else {
                            setTimeout(checkFirebase, 100);
                        }
                    };
                    checkFirebase();
                });

                const products = await window.FirebaseService.getProducts();
                const product = products.find(p => p.id === productId);

                if (product) {
                    displayProduct(product);
                    loadRelatedProducts(product, products);
                    loadingState.classList.add('hidden');
                    productContent.classList.remove('hidden');
                } else {
                    loadingState.classList.add('hidden');
                    errorState.classList.remove('hidden');
                }
            } catch (err) {
                console.error("Error loading product details:", err);
                loadingState.classList.add('hidden');
                errorState.classList.remove('hidden');
            }
        }

        function displayProduct(product) {
            document.title = `${product.name} - S Shop LK`;
            
            // Breadcrumbs
            const categorySlug = product.category ? product.category.toLowerCase().replace(/ & /g, '-').replace(/ /g, '-') : 'products';
            const categoryLink = document.getElementById('breadcrumb-category');
            categoryLink.textContent = product.category || 'Products';
            categoryLink.href = `category-${categorySlug}.html`;
            document.getElementById('breadcrumb-product-name').textContent = product.name;

            // Main details
            document.getElementById('product-image').src = product.image || 'https://placehold.co/600x400/1e293b/e2e8f0?text=No+Image';
            document.getElementById('product-image').alt = product.name;
            document.getElementById('product-name').textContent = product.name;
            document.getElementById('product-description').textContent = product.description;
            document.getElementById('product-price').textContent = `LKR ${product.price.toLocaleString()}`;
            document.getElementById('product-sold').textContent = `${product.soldCount || 0} sold`;

            // Trust Badge
            if (product.trustBadge) {
                document.getElementById('trust-badge-text').textContent = product.trustBadge;
                document.getElementById('trust-badge-container').classList.remove('hidden');
            }

            // Key Details
            if (product.availability) {
                document.getElementById('product-availability').textContent = `${product.availability} in stock`;
                document.getElementById('availability-container').classList.remove('hidden');
            }
            if (product.category) {
                document.getElementById('product-category').textContent = product.category;
                document.getElementById('category-container').classList.remove('hidden');
            }
            if (product.deliverySpeed) {
                document.getElementById('product-delivery-speed').textContent = product.deliverySpeed;
                document.getElementById('delivery-speed-container').classList.remove('hidden');
            }
            if (product.deliveryMethod) {
                document.getElementById('product-delivery-method').textContent = product.deliveryMethod;
                document.getElementById('delivery-method-container').classList.remove('hidden');
            }
            if (product.activationRegion) {
                document.getElementById('product-activation-region').textContent = product.activationRegion;
                document.getElementById('activation-region-container').classList.remove('hidden');
            }

            // Other sellers
            if (product.otherSellers > 0) {
                document.getElementById('product-other-sellers').textContent = product.otherSellers;
                document.getElementById('other-sellers-container').classList.remove('hidden');
            }

            // Buy button
            const buyNowButton = document.getElementById('buy-now-button');
            buyNowButton.onclick = () => showBuyNowModal(product.name);
        }

        function loadRelatedProducts(currentProduct, allProducts) {
            const relatedProductsSection = document.getElementById('related-products-section');

            if (!currentProduct.category) {
                relatedProductsSection.classList.add('hidden');
                return;
            }

            const relatedProducts = allProducts.filter(p => 
                p.category === currentProduct.category && p.id !== currentProduct.id
            ).slice(0, 4); // Get up to 4 related products

            if (relatedProducts.length > 0) {
                displayRelatedProducts(relatedProducts);
                relatedProductsSection.classList.remove('hidden');
            } else {
                relatedProductsSection.classList.add('hidden');
            }
        }

        function displayRelatedProducts(relatedProducts) {
            const container = document.getElementById('related-products-container');
            container.innerHTML = ''; // Clear previous content

            relatedProducts.forEach(product => {
                const detailPage = `dynamic-product-detail.html?id=${product.id}`;
                const productCard = document.createElement('div');
                productCard.className = 'bg-slate-800 rounded-xl shadow-lg hover:shadow-blue-500/20 transition-all duration-300 border border-slate-700';
                
                productCard.innerHTML = `
                    <a href="${detailPage}">
                        <img src="${product.image || 'https://placehold.co/400x300/1e293b/e2e8f0?text=No+Image'}" alt="${product.name}" class="w-full h-40 object-cover rounded-t-xl border-b border-slate-700">
                    </a>
                    <div class="p-4">
                        <h3 class="text-md font-semibold text-white truncate mb-1"><a href="${detailPage}" class="hover:text-blue-400">${product.name}</a></h3>
                        <span class="text-lg font-bold text-blue-400">LKR ${product.price.toLocaleString()}</span>
                    </div>
                `;
                container.appendChild(productCard);
            });
        }

        function showBuyNowModal(productName) {
            const modal = document.getElementById('buyNowModal');
            document.getElementById('productNameInModal').textContent = productName;

            const whatsappNumber = '+94767854069'; 
            const whatsappMessage = encodeURIComponent(`Hello, I would like to buy: ${productName}`);
            document.getElementById('whatsappLink').href = `https://wa.me/${whatsappNumber}?text=${whatsappMessage}`;

            const discordUserId = '1078335412713570314'; 
            document.getElementById('discordLink').href = `https://discordapp.com/users/${discordUserId}`;

            modal.classList.remove('hidden');
        }

        function closeModal() {
            const modal = document.getElementById('buyNowModal');
            modal.classList.add('hidden');
        }
    </script>

</body>
</html>