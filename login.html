<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal - S Shop LK</title>
    <link rel="icon" type="image/png" href="https://i.ibb.co/FqsbsjVB/S-shop-lk-logo.png">
    <script src="favicon.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="font-loader.js"></script>
    <script src="breadcrumb.js"></script>

    <style>
        body {
            background-color: #0f172a;
            color: #e2e8f0;
            overflow-x: hidden;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #334155; }

        .login-gradient {
            background: linear-gradient(135deg, #0f172a 0%, #173783 100%);
        }

        /* Sliding Logic Preservation */
        .forms-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }

        .auth-form {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            transition: opacity 0.3s ease;
            background: white;
        }

        #loginFormWrapper {
            top: 0;
            left: 0;
            opacity: 1;
            z-index: 2;
        }

        #signupFormWrapper {
            top: 0;
            left: 100%;
            opacity: 0;
            z-index: 1;
        }

        /* Active State */
        #mainContainer.show-signup .forms-wrapper {
            transform: translateX(-100%);
        }

        #mainContainer.show-signup #signupFormWrapper {
            opacity: 1;
            z-index: 2;
        }

        #mainContainer.show-signup #loginFormWrapper {
            opacity: 0;
            z-index: 1;
        }

        /* Toast */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: #fff;
            color: #121212;
            padding: 12px 24px;
            border-radius: 50px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            font-weight: 500;
            z-index: 3000;
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .toast.show { transform: translateX(-50%) translateY(0); }
        .toast.error { border-left: 4px solid #d32f2f; }
        .toast.success { border-left: 4px solid #4caf50; }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .modal-overlay.active { display: flex; opacity: 1; }
    </style>
</head>

<body class="flex flex-col min-h-screen">

    <!-- Header -->
    <div id="header-container" class="w-full"></div>

    <!-- Toast -->
    <div id="toast" class="toast">
        <i id="toastIcon" class="fas fa-info-circle"></i>
        <span id="toastMsg">Notification</span>
    </div>

    <main class="flex-grow flex flex-col w-full">
        
        <!-- Main Card -->
        <div id="mainContainer" class="flex w-full bg-white overflow-hidden min-h-[650px] lg:min-h-[850px] relative flex-grow">
            
            <!-- Left Side (Brand) -->
            <div class="hidden lg:flex lg:w-1/2 login-gradient p-12 flex-col justify-between text-white relative">
                <div class="absolute top-[-10%] left-[-10%] w-64 h-64 rounded-full bg-white/10 blur-3xl"></div>
                <div class="absolute bottom-[-5%] right-[-5%] w-96 h-96 rounded-full bg-indigo-900/20 blur-3xl"></div>

                <div class="relative z-10 flex items-center space-x-3">
                    <img src="https://i.ibb.co/FqsbsjVB/S-shop-lk-logo.png" alt="Logo" class="h-12 w-12">
                    <span class="text-3xl font-black tracking-tight">S Shop LK</span>
                </div>

                <div class="relative z-10">
                    <h2 class="text-5xl font-extrabold leading-tight mb-6">
                        Join the <br> <span class="text-blue-400">Community</span>
                    </h2>
                    <p class="text-blue-100 text-lg opacity-80 leading-relaxed">
                        Access exclusive deals, track your orders, and manage your digital assets in one place.
                    </p>
                </div>

                <div class="relative z-10 grid grid-cols-2 gap-4">
                    <div class="bg-white/10 p-4 rounded-xl border border-white/10 backdrop-blur-sm">
                        <h4 class="font-bold">Secure</h4>
                        <p class="text-xs text-blue-200 opacity-70">Encrypted data</p>
                    </div>
                    <div class="bg-white/10 p-4 rounded-xl border border-white/10 backdrop-blur-sm">
                        <h4 class="font-bold">Fast</h4>
                        <p class="text-xs text-blue-200 opacity-70">Instant access</p>
                    </div>
                </div>
            </div>

            <!-- Right Side (Forms) -->
            <div class="w-full lg:w-1/2 relative bg-white text-gray-900">
                <div class="forms-wrapper">
                    
                    <!-- Login Form -->
                    <div id="loginFormWrapper" class="auth-form p-8 sm:p-12">
                        <div class="text-center mb-8">
                            <h1 class="text-3xl font-bold text-gray-900">Welcome Back</h1>
                            <p class="text-gray-500 mt-2">Sign in to your account</p>
                        </div>

                        <form id="loginForm" class="space-y-5">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1.5">Email</label>
                                <input type="email" id="loginEmail" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all" placeholder="name@example.com" required>
                            </div>
                            <div>
                                <div class="flex justify-between mb-1.5">
                                    <label class="block text-sm font-semibold text-gray-700">Password</label>
                                    <span class="text-xs font-bold text-blue-600 cursor-pointer hover:underline" onclick="openModal('forgotModal')">Forgot?</span>
                                </div>
                                <input type="password" id="loginPass" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all" placeholder="••••••••" required>
                            </div>
                            <button type="submit" class="w-full bg-blue-600 text-white py-3.5 rounded-xl font-bold hover:bg-blue-700 transition-all shadow-lg shadow-blue-200">Sign In</button>
                        </form>

                        <div class="relative my-8">
                            <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-200"></div></div>
                            <div class="relative flex justify-center text-sm"><span class="px-4 bg-white text-gray-400">Or continue with</span></div>
                        </div>

                        <div class="grid grid-cols-1 gap-3">
                            <button onclick="handleGoogleLogin()" class="flex items-center justify-center gap-2 p-3 border border-gray-200 rounded-xl hover:bg-gray-50 transition-colors">
                                <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-5 h-5" alt="Google">
                                <span class="font-medium text-gray-600">Continue with Google</span>
                            </button>
                        </div>

                        <div class="text-center mt-8">
                            <p class="text-gray-500">Don't have an account? <span class="text-blue-600 font-bold cursor-pointer hover:underline" onclick="toggleMode()">Create one</span></p>
                        </div>
                    </div>

                    <!-- Signup Form -->
                    <div id="signupFormWrapper" class="auth-form p-8 sm:p-12">
                        <div class="text-center mb-8">
                            <h1 class="text-3xl font-bold text-gray-900">Create Account</h1>
                            <p class="text-gray-500 mt-2">Join S Shop LK today</p>
                        </div>

                        <form id="registerForm" class="space-y-5">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1.5">Full Name</label>
                                <input type="text" id="regName" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all" placeholder="John Doe" required>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1.5">Email</label>
                                <input type="email" id="regEmail" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all" placeholder="name@example.com" required>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1.5">Password</label>
                                <input type="password" id="regPass" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all" placeholder="Create a password" required>
                            </div>
                            <button type="submit" class="w-full bg-blue-600 text-white py-3.5 rounded-xl font-bold hover:bg-blue-700 transition-all shadow-lg shadow-blue-200">Create Account</button>
                        </form>

                        <div class="relative my-8">
                            <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-200"></div></div>
                            <div class="relative flex justify-center text-sm"><span class="px-4 bg-white text-gray-400">Or sign up with</span></div>
                        </div>

                        <div class="grid grid-cols-1 gap-3">
                            <button onclick="handleGoogleLogin()" class="flex items-center justify-center gap-2 p-3 border border-gray-200 rounded-xl hover:bg-gray-50 transition-colors">
                                <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-5 h-5" alt="Google">
                                <span class="font-medium text-gray-600">Sign up with Google</span>
                            </button>
                        </div>

                        <div class="text-center mt-8">
                            <p class="text-gray-500">Already have an account? <span class="text-blue-600 font-bold cursor-pointer hover:underline" onclick="toggleMode()">Log in</span></p>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <div id="footer-container" class="w-full"></div>

    <!-- Forgot Password Modal -->
    <div id="forgotModal" class="modal-overlay">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md transform scale-100 transition-transform">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-lock text-2xl text-blue-600"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-900">Reset Password</h2>
                <p class="text-gray-500 mt-2">Enter your email to receive a reset link.</p>
            </div>
            <input type="email" id="resetEmail" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 mb-6 text-gray-900" placeholder="name@example.com">
            <div class="flex gap-3">
                <button class="flex-1 bg-gray-100 text-gray-700 py-3 rounded-xl font-bold hover:bg-gray-200 transition-colors" onclick="closeModal('forgotModal')">Cancel</button>
                <button class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition-colors" onclick="handleReset()">Send Link</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="header-component.js"></script>
    <script src="footer-component.js"></script>

    <script>
        // --- CONFIGURATION ---
        const firebaseConfig = {
    apiKey: "AIzaSyBXQxty-9mU_PFONIE0RGgs3gg2G8gi1ng",
    authDomain: "sshop-lk.firebaseapp.com",
    projectId: "sshop-lk",
    storageBucket: "sshop-lk.firebasestorage.app",
    messagingSenderId: "1032750720586",
    appId: "1:1032750720586:web:3b08580929f8e1686f68b3",
    measurementId: "G-4XQTJVKS72"
  };
  
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- HELPER: SAVE TO DB ---
        function saveUserToDB(user) {
            return db.collection("users").doc(user.uid).set({
                name: user.displayName || "Member",
                email: user.email,
                photo: user.photoURL || "",
                lastLogin: new Date().toISOString(),
                role: "member"
            }, { merge: true });
        }

        // --- 1. SIGN UP (With Verification Email) ---
        document.getElementById('registerForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('regEmail').value;
            const pass = document.getElementById('regPass').value;
            const name = document.getElementById('regName').value;

            firebase.auth().createUserWithEmailAndPassword(email, pass)
                .then((userCredential) => {
                    const user = userCredential.user;

                    // 1. Update Name
                    user.updateProfile({ displayName: name }).then(() => {

                        // 2. SEND VERIFICATION EMAIL
                        user.sendEmailVerification().then(() => {
                            // 3. Force Logout
                            firebase.auth().signOut();

                            // 4. Show Message with Spam warning
                            alert(
                                `Verification email sent to ${email}!\n\n` +
                                `NOTE: Since this is a free student project, the email will come from "support@sshoplk.xyz".\n\n` +
                                `Please check your SPAM or JUNK folder if you don't see it.`
                            );
                            toggleMode(); // Go back to login screen
                        });
                    });
                })
                .catch((error) => {
                    showToast(error.message, 'error');
                });
        });

        // --- 2. SIGN IN (Check Verification) ---
        document.getElementById('loginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const pass = document.getElementById('loginPass').value;

            firebase.auth().signInWithEmailAndPassword(email, pass)
                .then((userCredential) => {
                    const user = userCredential.user;

                    // --- CRITICAL CHECK: IS EMAIL VERIFIED? ---
                    if (user.emailVerified) {
                        showToast(`Welcome back!`);
                        saveUserToDB(user);
                        localStorage.setItem('currentUser', JSON.stringify({
                            name: user.displayName || "Member",
                            email: user.email,
                            photo: user.photoURL
                        }));
                        setTimeout(() => window.location.href = '/index.html', 1500);

                    } else {
                        firebase.auth().signOut();
                        alert("Your email is not verified yet! Please check your inbox (and spam folder) for the verification link.");
                    }
                })
                .catch((error) => {
                    showToast("Invalid email or password", 'error');
                });
        });

        // --- GOOGLE/GITHUB ---
        function handleSocialLogin(providerName) {
            const provider = providerName === 'google'
                ? new firebase.auth.GoogleAuthProvider()
                : new firebase.auth.GithubAuthProvider();

            firebase.auth().signInWithPopup(provider)
                .then((result) => {
                    const user = result.user;
                    saveUserToDB(user);
                    localStorage.setItem('currentUser', JSON.stringify({
                        name: user.displayName || user.email,
                        email: user.email,
                        photo: user.photoURL
                    }));
                    showToast(`Welcome ${user.displayName}!`);
                    setTimeout(() => window.location.href = 'index.html', 1500);
                }).catch((e) => showToast(e.message, 'error'));
        }

        // Mapping buttons
        function handleGoogleLogin() { handleSocialLogin('google'); }
        function handleGithubLogin() { handleSocialLogin('github'); }

        // --- UTILS ---
        const container = document.getElementById('mainContainer');
        function toggleMode() { container.classList.toggle('show-signup'); }

        function showToast(msg, type = 'success') {
            const toast = document.getElementById('toast');
            const txt = document.getElementById('toastMsg');
            txt.textContent = msg;
            toast.className = 'toast show ' + type;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        function handleReset() {
            const email = document.getElementById('resetEmail').value;
            if (email) {
                firebase.auth().sendPasswordResetEmail(email)
                    .then(() => { closeModal('forgotModal'); alert("Reset link sent!"); })
                    .catch(e => alert(e.message));
            }
        }
        function simulateSocialLogin(provider) {
            alert("Facebook login requires App Review. Use Google or GitHub for now!");
        }
        // --- PASSWORD RESET LOGIC (With "User Check") ---
        function handleReset() {
            const emailInput = document.getElementById('resetEmail');
            const email = emailInput.value;

            // 1. Check if empty
            if (!email) {
                showToast("Please enter your email address first.", "error");
                return;
            }

            // 2. Try to send the email
            firebase.auth().sendPasswordResetEmail(email)
                .then(() => {
                    // SUCCESS: User exists, email sent
                    closeModal('forgotModal');
                    emailInput.value = "";
                    alert(
                        `Password reset link sent to: ${email}\n\n` +
                        `Please check your Inbox (and Spam folder).`
                    );
                })
                .catch((error) => {
                    console.error(error); // Debugging

                    // --- THIS IS THE CHECK YOU ASKED FOR ---
                    if (error.code === 'auth/user-not-found') {
                        // User does NOT exist
                        closeModal('forgotModal');
                        alert("No account found with this email!\n\nPlease create an account first.");

                        // Smart Move: Automatically switch to the Sign Up form
                        const container = document.getElementById('mainContainer');
                        if (!container.classList.contains('show-signup')) {
                            toggleMode();
                        }
                    }
                    else if (error.code === 'auth/invalid-email') {
                        showToast("That email address is invalid.", "error");
                    }
                    else {
                        showToast("Error: " + error.message, "error");
                    }
                });
        }

    </script>
</body>

</html>