<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat with Admin - S Shop LK</title>
    <link rel="icon" type="image/png" href="https://i.ibb.co/FqsbsjVB/S-shop-lk-logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
            height: 100vh;
            overflow: hidden;
        }
        
        .chat-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .messages-container {
            flex: 1;
            overflow-y: auto;
            scroll-behavior: smooth;
        }
        
        .message-bubble {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .typing-indicator {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 1; }
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b;
        }
        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }
        
        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .neon-glow {
            text-shadow: 0 0 10px rgba(59, 130, 246, 0.8);
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <!-- Header -->
        <div class="bg-slate-800 border-b border-slate-700 px-4 py-3 flex items-center justify-between">
                <div class="flex items-center space-x-3">
                <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center">
                    <svg class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                        </svg>
                    </div>
                    <div>
                    <h1 class="text-base font-semibold text-white">S Shop LK Support</h1>
                        <div class="flex items-center space-x-2">
                            <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse admin-status-dot"></div>
                        <span class="text-xs text-green-400 admin-status-text">Online</span>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center space-x-3">
                <div class="flex items-center space-x-2">
                    <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                    <span id="userInfo" class="text-xs text-white">Welcome, Guest</span>
                </div>
                <a href="index.html" class="glass px-3 py-1.5 rounded-full text-white hover:bg-white/20 transition-all duration-300 flex items-center space-x-1 text-sm">
                    <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                        </svg>
                    <span class="hidden sm:inline">Back</span>
                </a>
            </div>
        </div>

        <!-- Messages Container -->
        <div class="messages-container p-3 space-y-3" id="messagesContainer">
            <!-- Welcome Message -->
            <div class="flex justify-center">
                <div class="glass px-3 py-2 rounded-full text-center">
                    <p class="text-xs text-gray-300">Welcome to S Shop LK Support! How can we help you today?</p>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="border-t border-slate-700 p-3">
            <form id="messageForm" class="flex space-x-3">
                <div class="flex-1 relative">
                    <textarea 
                        id="messageInput" 
                        placeholder="Type your message here..." 
                        class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none text-sm"
                        rows="1"
                        maxlength="500"
                    ></textarea>
                    <div class="absolute bottom-1 right-1 text-xs text-gray-400" id="charCount">0/500</div>
                </div>
                <button 
                    type="submit" 
                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors duration-300 flex items-center space-x-1 text-sm"
                    id="sendButton"
                >
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                    </svg>
                    <span class="hidden sm:inline">Send</span>
                </button>
            </form>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>

    <!-- Audio for notifications -->
    <audio id="notificationSound" preload="auto">
        <source src="https://widespread-blue-ygukcnbp4v.edgeone.app/new-notification-09-352705.mp3" type="audio/mpeg">
    </audio>

    <script>
        let currentUserId = null;
        let currentChatId = null;
        let messageListener = null;
        let adminStatusListener = null;
        let lastMessageCount = 0; // Track message count for notifications
        let isNotificationsEnabled = true; // Track notification preference

        // Initialize chat when page loads
        window.addEventListener('load', function() {
            initializeChat();
            setupEventListeners();
            setupMessageNotifications();
            checkAdminStatus();
        });

        // Notification functions
        function playNotificationSound() {
            try {
                const audio = document.getElementById('notificationSound');
                if (audio && isNotificationsEnabled) {
                    audio.currentTime = 0; // Reset to beginning
                    audio.play().catch(error => {
                        console.log('Audio play failed:', error);
                    });
                }
            } catch (error) {
                console.log('Notification sound error:', error);
            }
        }

        function showNotification(title, body) {
            if ('Notification' in window && Notification.permission === 'granted' && isNotificationsEnabled) {
                new Notification(title, {
                    body: body,
                    icon: 'https://i.ibb.co/FqsbsjVB/S-shop-lk-logo.png',
                    badge: 'https://i.ibb.co/FqsbsjVB/S-shop-lk-logo.png'
                });
            }
        }

        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }

        function setupMessageNotifications() {
            // Request notification permission on page load
            requestNotificationPermission();
            
            // Load saved notification preference
            const savedPreference = localStorage.getItem('userNotificationsEnabled');
            if (savedPreference !== null) {
                isNotificationsEnabled = savedPreference === 'true';
            }
        }

        // Check admin online status
        function checkAdminStatus() {
            if (window.FirebaseService) {
                try {
                    // Listen for admin status changes
                    adminStatusListener = FirebaseService.onAdminStatusChange((isOnline) => {
                        updateAdminStatus(isOnline);
                    });
                } catch (error) {
                    console.warn('Admin status tracking blocked by ad blocker or network issue:', error);
                    // Set default status as offline when blocked
                    updateAdminStatus(false);
                    showAdBlockerWarning();
                }
            }
        }

        // Update admin status display
        function updateAdminStatus(isOnline) {
            const statusDot = document.querySelector('.admin-status-dot');
            const statusText = document.querySelector('.admin-status-text');
            
            if (statusDot && statusText) {
                if (isOnline) {
                    statusDot.className = 'w-2 h-2 bg-green-400 rounded-full animate-pulse admin-status-dot';
                    statusText.textContent = 'Online';
                    statusText.className = 'text-sm text-green-400 admin-status-text';
                } else {
                    statusDot.className = 'w-2 h-2 bg-gray-400 rounded-full admin-status-dot';
                    statusText.textContent = 'Offline';
                    statusText.className = 'text-sm text-gray-400 admin-status-text';
                }
            }
        }

        // Show warning about ad blocker
        function showAdBlockerWarning() {
            const warningDiv = document.createElement('div');
            warningDiv.className = 'fixed top-4 left-4 bg-yellow-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 max-w-sm';
            warningDiv.innerHTML = `
                <div class="flex items-center space-x-2">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z" />
                    </svg>
                    <div>
                        <p class="font-semibold">Ad Blocker Detected</p>
                        <p class="text-xs">Admin status may not update correctly. Consider disabling ad blocker for this site.</p>
                    </div>
                </div>
            `;
            
            document.body.appendChild(warningDiv);
            
            // Remove warning after 8 seconds
            setTimeout(() => {
                warningDiv.remove();
            }, 8000);
        }

        function initializeChat() {
            // Check if user is logged in via Firebase Auth
            if (window.AuthService) {
                AuthService.onAuthStateChanged(function(user) {
                    if (user) {
                        // User is logged in via Firebase Auth
                        initializeChatWithFirebaseUser(user);
                    } else {
                        // User is not logged in, redirect to website login
                        window.location.href = 'login.html';
                    }
                });
            } else {
                // Firebase Auth not available, redirect to website login
                window.location.href = 'login.html';
            }
        }

        function initializeChatWithFirebaseUser(user) {
            try {
                // Use Firebase Auth user ID
                currentUserId = user.uid;
                
                // Get username from user data or use email
                let userName = user.displayName || user.email.split('@')[0];
                
                // Try to get username from Firestore
                if (window.FirebaseService) {
                    FirebaseService.getUser(user.uid)
                        .then(userData => {
                            if (userData && userData.username) {
                                userName = userData.username;
                            }
                            document.getElementById('userInfo').textContent = `Welcome, ${userName}`;
                            getOrCreateChat(userName);
                        })
                        .catch(error => {
                            console.log('Could not fetch user data, using default name');
                            document.getElementById('userInfo').textContent = `Welcome, ${userName}`;
                            getOrCreateChat(userName);
                        });
                } else {
                    document.getElementById('userInfo').textContent = `Welcome, ${userName}`;
                    getOrCreateChat(userName);
                }
            } catch (error) {
                console.error('Error initializing chat with Firebase user:', error);
                // Redirect to website login
                window.location.href = 'login.html';
            }
        }

        async function getOrCreateChat(userName) {
            try {
                // Check if user has an existing chat
                const existingChats = await FirebaseService.getChats();
                const userChat = existingChats.find(chat => chat.userId === currentUserId);

                if (userChat) {
                    currentChatId = userChat.id;
                    loadMessages();
                } else {
                    // Create new chat with real user name
                    const chatData = {
                        userId: currentUserId,
                        userName: userName,
                        status: 'active'
                    };
                    currentChatId = await FirebaseService.createChat(chatData);
                }

                // Set up real-time listener for messages
                setupMessageListener();
            } catch (error) {
                console.error('Error initializing chat:', error);
                showError('Failed to initialize chat. Please refresh the page.');
            }
        }

        async function loadMessages() {
            if (!currentChatId) return;

            const messagesContainer = document.getElementById('messagesContainer');
            
            // Clear welcome message
            const welcomeMessage = messagesContainer.querySelector('.flex.justify-center');
            if (welcomeMessage) {
                welcomeMessage.remove();
            }

            try {
                const messages = await FirebaseService.getMessages(currentChatId);
                messages.forEach(message => {
                    displayMessage(message, message.id);
                });
                scrollToBottom();
            } catch (error) {
                console.error('Error loading messages:', error);
                showError('Failed to load messages');
            }
        }

        function displayMessage(messageData, messageId) {
            const messagesContainer = document.getElementById('messagesContainer');
            const isAdmin = messageData.sender === 'admin';
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${isAdmin ? 'justify-start' : 'justify-end'} message-bubble`;
            
            const time = messageData.timestamp ? new Date(messageData.timestamp.toDate()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 'Just now';
            
            messageDiv.innerHTML = `
                <div class="max-w-xs lg:max-w-md">
                    <div class="bg-${isAdmin ? 'slate-700' : 'blue-600'} text-white rounded-lg px-3 py-2 shadow-lg">
                        <p class="text-sm">${messageData.text}</p>
                        <div class="flex items-center justify-between mt-1">
                            <span class="text-xs opacity-75">${isAdmin ? 'Admin' : 'You'}</span>
                            <span class="text-xs opacity-75">${time}</span>
                        </div>
                    </div>
                </div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
        }

        function setupEventListeners() {
            const messageForm = document.getElementById('messageForm');
            const messageInput = document.getElementById('messageInput');
            const charCount = document.getElementById('charCount');

            messageForm.addEventListener('submit', function(e) {
                e.preventDefault();
                sendMessage();
            });

            // Auto-resize textarea
            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
                
                // Update character count
                const count = this.value.length;
                charCount.textContent = `${count}/500`;
                charCount.className = count > 450 ? 'absolute bottom-1 right-1 text-xs text-red-400' : 'absolute bottom-1 right-1 text-xs text-gray-400';
            });

            // Handle Enter key
            messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        }

        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message || !currentChatId) return;

            const sendButton = document.getElementById('sendButton');
            sendButton.disabled = true;
            sendButton.innerHTML = `
                <svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
                <span class="hidden sm:inline">Sending...</span>
            `;

            try {
                // Add message to Firebase using service
                await FirebaseService.addMessage(currentChatId, {
                    text: message,
                    sender: 'user',
                    userId: currentUserId
                });

                // Update chat last message time
                await FirebaseService.updateChat(currentChatId, {
                    lastMessageAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastMessage: message
                });

                // Clear input
                messageInput.value = '';
                messageInput.style.height = 'auto';
                document.getElementById('charCount').textContent = '0/500';

            } catch (error) {
                console.error('Error sending message:', error);
                showError('Failed to send message');
            } finally {
                sendButton.disabled = false;
                sendButton.innerHTML = `
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                    </svg>
                    <span class="hidden sm:inline">Send</span>
                `;
            }
        }

        function setupMessageListener() {
            if (!currentChatId) return;

            // Set up real-time listener for new messages
            messageListener = FirebaseService.onChatMessagesChange((chatId, messages) => {
                // Only process messages for the current chat
                if (chatId !== currentChatId) return;
                
                const messagesContainer = document.getElementById('messagesContainer');
                
                // Check for new messages and play notification
                if (messages && messages.length > lastMessageCount) {
                    const newMessages = messages.slice(lastMessageCount);
                    lastMessageCount = messages.length;
                    
                    // Play sound for new admin messages
                    newMessages.forEach(message => {
                        if (message.sender === 'admin') { // Only notify for admin messages
                            playNotificationSound();
                            
                            // Show browser notification if not focused
                            if (!document.hasFocus()) {
                                showNotification('Admin Response', `${message.text.substring(0, 50)}${message.text.length > 50 ? '...' : ''}`);
                            }
                        }
                    });
                }
                
                // Clear existing messages except welcome message
                const welcomeMessage = messagesContainer.querySelector('.flex.justify-center');
                messagesContainer.innerHTML = '';
                if (welcomeMessage) {
                    messagesContainer.appendChild(welcomeMessage);
                }
                
                // Display all messages
                messages.forEach(message => {
                    displayMessage(message, message.id);
                });
            });
        }

        function scrollToBottom() {
            const messagesContainer = document.getElementById('messagesContainer');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showError(message) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-red-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        function logout() {
            // If user was logged in via Firebase Auth, sign them out
            if (window.AuthService) {
                AuthService.signOut()
                    .then(() => {
                        console.log('Signed out from Firebase Auth');
                        window.location.href = 'login.html';
                    })
                    .catch(error => {
                        console.error('Error signing out from Firebase Auth:', error);
                        window.location.href = 'login.html';
                    });
            } else {
                window.location.href = 'login.html';
            }
        }

        function toggleUserNotifications() {
            isNotificationsEnabled = !isNotificationsEnabled;
            localStorage.setItem('userNotificationsEnabled', isNotificationsEnabled);
            const toggleButton = document.getElementById('userNotificationToggle');
            if (isNotificationsEnabled) {
                toggleButton.innerHTML = `
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                    </svg>
                    <span class="hidden sm:inline">Sound</span>
                `;
            } else {
                toggleButton.innerHTML = `
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                    </svg>
                    <span class="hidden sm:inline">Mute</span>
                `;
            }
        }

        // Clean up listener on page unload
        window.addEventListener('beforeunload', function() {
            if (messageListener) {
                messageListener();
            }
            if (adminStatusListener) {
                adminStatusListener();
            }
        });
    </script>
</body>
</html> 