
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S Shop LK - Your Gaming & Digital Marketplace</title>
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="https://i.ibb.co/7JWLrP7v/sshoplk-favicon.webp">
    <link rel="shortcut icon" type="image/png" href="https://i.ibb.co/7JWLrP7v/sshoplk-favicon.webp">
    <script src="favicon.js"></script>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Rate Limiting Configuration -->
    <script src="rate-limit-config.js"></script>
    <!-- Status Monitor -->
    <script src="status-monitor.js"></script>
    <script src="font-loader.js"></script>
    <script src="widgets\platforms-ani.js"></script>
    <script src="widgets\hero-section.js"></script>
    <script src="widgets\new-arrivals.js"></script>
    <script src="widgets\product-categories.js"></script>
    <script src="widgets\CTA-section.js"></script>
    <style>
        body {
            background-color: #0f172a; /* Dark blue background */
            color: #e2e8f0; /* Light gray text */
        }
        /* Custom scrollbar for a cleaner look on the dark theme */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }
        
        /* Line clamp utility for truncating text */
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            line-clamp: 2;
        }
        
        /* Mobile header scroll behavior */
        @media (max-width: 768px) {
            header {
                transition: background-color 0.3s ease-in-out, backdrop-filter 0.3s ease-in-out;
            }
            
            header.header-scrolled {
                background-color: rgba(15, 23, 42, 0.8); /* bg-slate-900 with 80% opacity */
                backdrop-filter: blur(8px);
            }
        }

        /* Autocomplete styles */
        .suggestion-item {
            transition: background-color 0.2s ease;
        }
        .suggestion-item:hover {
            background-color: #334155;
        }
        .suggestion-item.selected {
            background-color: #475569;
            color: #fff;
        }

    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- Loading System -->
    <script src="loading.js"></script>

    <!-- Replace header -->
    <div id="header-container"></div>

    <!-- Hero Section -->
    <div id="hero-section-container"></div>

    <!-- Main Content Area -->
    <main class="flex-grow container mx-auto px-4 py-8 md:py-16">
        
        <!-- Featured Products Section -->
        <div id="new-arrivals-container"></div>

        <!-- Platforms Animation -->
        <br>
        <div id="platforms-animation-container"></div>
        <br>

        <!-- New Buyer-Focused CTA Section -->
        <div id="cta-section-container"></div>

        <!-- Product Categories Section -->
        <div id="product-categories-container"></div>

    </main>


    <!-- The script that generates the banner -->
    <script src="widgets\banner-widget1.js"></script>

    <!-- Testimonials Widget -->
    <div id="testimonials-widget-container"></div>
<!-- Keep your main content here -->

<!-- Replace footer -->
<div id="footer-container"></div>

    <!-- Buy Now Modal (Pop-up Panel) -->
    <div id="buyNowModal" role="dialog" aria-modal="true" aria-labelledby="modalTitle" class="fixed inset-0 bg-gray-950 bg-opacity-75 flex items-center justify-center z-[1000] p-4 hidden">
        <div class="bg-gray-800 rounded-lg shadow-2xl p-6 md:p-8 w-full max-w-sm text-center border-2 border-blue-600 relative">
            <!-- Close Button -->
            <button aria-label="Close modal" class="absolute top-4 right-4 text-gray-400 hover:text-white" onclick="closeModal()">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>

            <h3 class="text-2xl font-bold mb-2 text-white" id="modalTitle">How would you like to buy?</h3>
            <p class="text-gray-400 mb-6" id="modalDescription">Contact us to complete your purchase of "<span id="productNameInModal" class="font-semibold text-white">Product Name</span>".</p>
            
            <div class="flex flex-col space-y-4">
                <!-- WhatsApp Button -->
                <a href="#" id="whatsappLink" class="flex items-center justify-center space-x-2 bg-green-500 text-white py-3 rounded-lg font-semibold hover:bg-green-600 transition-colors duration-300">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/6b/WhatsApp.svg/512px-WhatsApp.svg.png" alt="WhatsApp Icon" class="h-6 w-6">
                    <span>Buy on WhatsApp</span>
                </a>

                <!-- Discord Button -->
                <a href="#" id="discordLink" class="flex items-center justify-center space-x-2 bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors duration-300">
                    <img src="https://cdn-icons-png.flaticon.com/512/4945/4945973.png" alt="Discord Icon" class="h-6 w-6">
                    <span>Buy on Discord</span>
                </a>
            </div>
        </div>
    </div>
    <!-- End of Buy Now Modal -->

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="firebase-config.js"></script>

<!-- Header Component Script -->
<script src="header-component.js"></script>

<!-- Breadcrumb Component Script -->
<script src="breadcrumb.js"></script>

<!-- Footer Component Script -->
<script src="footer-component.js"></script>

<!-- Page-specific JavaScript -->
    <script>
    let products = [];
    let currentCategory = 'all';

    // Load products on page load
    window.addEventListener('load', function() {
        // Wait for Firebase to be ready before initializing the page
        waitForFirebaseReady(() => {
            initializePage();
        });
        setupKeyboardShortcuts();
        setupAutocomplete();
    });

    // Handle search input
    function handleSearch() {
        const searchInput = document.getElementById('searchInput');
        if (searchInput.value.trim() !== '') {
            window.location.href = `products.html?search=${encodeURIComponent(searchInput.value.trim())}`;
        }
    }

    // Function to wait for Firebase to be initialized
    function waitForFirebaseReady(callback) {
        const checkInterval = setInterval(() => {
            if (window.FirebaseService && typeof window.FirebaseService.getProducts === 'function') {
                clearInterval(checkInterval);
                callback();
            }
        }, 100); // Check every 100ms
    }

    // Autocomplete functionality
    function setupAutocomplete() {
        const searchInput = document.getElementById('searchInput');
        const suggestionsContainer = document.getElementById('autocomplete-suggestions');
        let selectedSuggestionIndex = -1;

        searchInput.addEventListener('input', function() {
            const query = this.value.trim().toLowerCase();
            if (query.length < 2) {
                suggestionsContainer.innerHTML = '';
                suggestionsContainer.classList.add('hidden');
                return;
            }

            const matchedProducts = products.filter(product => 
                product.name.toLowerCase().includes(query) || 
                product.description.toLowerCase().includes(query)
            ).slice(0, 5); // Limit to 5 suggestions

            if (matchedProducts.length > 0) {
                suggestionsContainer.innerHTML = matchedProducts.map((product, index) => `
                    <a href="dynamic-product-detail.html?id=${product.id}" class="suggestion-item p-3 cursor-pointer flex items-center space-x-3" data-index="${index}">
                        <img src="${product.image}" alt="${product.name}" class="w-10 h-10 object-cover rounded-md">
                        <div>
                            <p class="text-white font-semibold">${product.name}</p>
                            <p class="text-gray-400 text-xs">LKR ${product.price.toLocaleString()}</p>
                        </div>
                    </a>
                `).join('');
                suggestionsContainer.classList.remove('hidden');
            } else {
                suggestionsContainer.innerHTML = '<div class="p-3 text-gray-400">No products found.</div>';
                suggestionsContainer.classList.remove('hidden');
            }
            selectedSuggestionIndex = -1; // Reset selection
        });

        searchInput.addEventListener('keydown', function(e) {
            const suggestions = suggestionsContainer.querySelectorAll('.suggestion-item');
            if (!suggestions || suggestions.length === 0) return;

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedSuggestionIndex = (selectedSuggestionIndex + 1) % suggestions.length;
                updateSelection(suggestions);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedSuggestionIndex = (selectedSuggestionIndex - 1 + suggestions.length) % suggestions.length;
                updateSelection(suggestions);
            } else if (e.key === 'Enter') {
                if (selectedSuggestionIndex > -1) {
                    e.preventDefault();
                    suggestions[selectedSuggestionIndex].click(); // This will now navigate due to the <a> tag
                } else {
                    handleSearch();
                }
                suggestionsContainer.classList.add('hidden');
            }
        });

        function updateSelection(suggestions) {
            suggestions.forEach((item, index) => {
                if (index === selectedSuggestionIndex) {
                    item.classList.add('selected');
                    item.scrollIntoView({ block: 'nearest' });
                } else {
                    item.classList.remove('selected');
                }
            });
        }

        // Close suggestions when clicking outside
        document.addEventListener('click', function(e) {
            if (!searchInput.contains(e.target) && !suggestionsContainer.contains(e.target)) {
                suggestionsContainer.classList.add('hidden');
            }
        });
    }

    // Override handleSearch to also hide suggestions
    function handleSearch() {
        const searchInput = document.getElementById('searchInput');
        const suggestionsContainer = document.getElementById('autocomplete-suggestions');
        if (searchInput.value.trim() !== '') {
            window.location.href = `products.html?search=${encodeURIComponent(searchInput.value.trim())}`;
        }
        suggestionsContainer.classList.add('hidden');
    }

    // Setup keyboard shortcuts for admin panel access
    function setupKeyboardShortcuts() {
        document.addEventListener('keydown', function(event) {
            // Ctrl + Alt + A (Windows/Linux) or Cmd + Alt + A (Mac)
            if ((event.ctrlKey || event.metaKey) && event.altKey && event.key === 'a') {
                event.preventDefault(); // Prevent default browser action
                window.location.href = 'admin-login.html';
            }
            
            // Ctrl + Alt + S (Windows/Linux) or Cmd + Alt + S (Mac)
            if ((event.ctrlKey || event.metaKey) && event.altKey && event.key === 's') {
                event.preventDefault(); // Prevent default browser action
                window.location.href = 'admin-login.html';
            }
        });
    }

    // Wait for Firebase to be fully loaded
    function waitForFirebase() {
        if (window.auth && window.AuthService) {
            console.log('Firebase is ready, initializing Google sign-in');
            initializeGoogleSignIn();
        } else {
            console.log('Waiting for Firebase to initialize...');
            setTimeout(waitForFirebase, 100);
        }
    }
    
    // Prevent multiple rapid page loads
    let pageLoadCount = 0;
    const MAX_LOADS_PER_MINUTE = 10;
    
    function checkPageLoadRate() {
        const now = Date.now();
        const oneMinuteAgo = now - (60 * 1000);
        
        // Clean old entries
        pageLoadCount = Math.max(0, pageLoadCount - 1);
        
        if (pageLoadCount >= MAX_LOADS_PER_MINUTE) {
            console.warn('Page load rate limit exceeded. Using cached data.');
            return false;
        }
        
        pageLoadCount++;
        return true;
    }
    
    // Cache warming mechanism
    function warmCache() {
        // Pre-load essential data to localStorage if not already present
        if (!localStorage.getItem('sShopProducts')) {
            fetch('products.json')
                .then(response => response.json())
                .then(data => {
                    localStorage.setItem('sShopProducts', JSON.stringify(data.products));
                    console.log('Cache warmed with products.json data');
                })
                .catch(error => {
                    console.warn('Failed to warm cache with products.json:', error);
                });
        }
        
        // Set default hero images if not present
        if (!localStorage.getItem('sShopHeroImages')) {
            const defaultImages = [
                {
                    url: 'https://placehold.co/600x400/805ad5/ffffff?text=S+Shop+LK',
                    alt: 'S Shop LK Hero 1',
                    title: 'Welcome to S Shop LK'
                },
                {
                    url: 'https://placehold.co/600x400/667eea/ffffff?text=Gaming+Products',
                    alt: 'S Shop LK Hero 2',
                    title: 'Gaming Products'
                },
                {
                    url: 'https://placehold.co/600x400/764ba2/ffffff?text=Best+Deals',
                    alt: 'S Shop LK Hero 3',
                    title: 'Best Deals'
                }
            ];
            localStorage.setItem('sShopHeroImages', JSON.stringify(defaultImages));
            console.log('Cache warmed with default hero images');
        }
    }
    
    // Rate limiting variables
    let lastFirebaseCall = 0;
    const MIN_CALL_INTERVAL = 2000; // 2 seconds between Firebase calls
    let isInitializing = false;

    // Initialize page with rate limiting
    function initializePage() {
        // Warm cache first
        warmCache();
        
        if (!checkPageLoadRate()) {
            // Use cached data if rate limit exceeded
            loadFromLocalStorage();
            return;
        }
        
        // Normal initialization
        loadProducts();
    }

    function loadProducts() {
        // Check rate limiting
        const now = Date.now();
        if (now - lastFirebaseCall < MIN_CALL_INTERVAL) {
            console.log('Rate limiting: skipping Firebase call, using cached data');
            loadFromLocalStorage();
            return;
        }
        
        // Try to load from Firebase first
        if (window.FirebaseService) {
            lastFirebaseCall = now;
            safeFirebaseCall(
                () => FirebaseService.getProducts(),
                () => {
                    loadFromLocalStorage();
                    return [];
                }
            ).then(firebaseProducts => {
                if (firebaseProducts && firebaseProducts.length > 0) {
                    products = firebaseProducts;
                    console.log('Loaded products from Firebase:', products);
                } else {
                    // Fallback to localStorage if no Firebase data
                    loadFromLocalStorage();
                }
            }).catch(error => {
                console.error('Error loading from Firebase:', error);
                loadFromLocalStorage();
            });
        } else {
            loadFromLocalStorage();
        }
    }

    function loadFromLocalStorage() {
        const storedProducts = localStorage.getItem('sShopProducts');
        if (storedProducts) {
            products = JSON.parse(storedProducts);
            console.log('Loaded products from localStorage:', products);
        } else {
            // If no products in Firebase or localStorage, show an empty state.
            console.warn('No products found in Firebase or localStorage.');
            products = [];
        }
    }
        
        /**
         * This function shows the buy now modal with the specified product name.
         * @param {string} productName The name of the product being purchased.
         */
        function showBuyNowModal(productName) {
            const modal = document.getElementById('buyNowModal');
            const productNameSpan = document.getElementById('productNameInModal');
            const whatsappLink = document.getElementById('whatsappLink');
            const discordLink = document.getElementById('discordLink');

            productNameSpan.textContent = productName;
            
            // Fetch settings from Firebase to get the latest contact info
            if (window.FirebaseService) {
                FirebaseService.getWebsiteSettings().then(settings => {
                    const whatsappNumber = settings.phoneNumber || '+94767854069';
                    const discordUrl = settings.discordLink || 'https://discord.gg/nsz5SFhXMh';
                    
                    const whatsappMessage = encodeURIComponent(`Hello, I would like to buy: ${productName}`);
                    whatsappLink.href = `https://wa.me/${whatsappNumber.replace(/\s/g, '')}?text=${whatsappMessage}`;
                    discordLink.href = discordUrl;
                });
            } else {
                // Fallback for when Firebase is not available
                const whatsappMessage = encodeURIComponent(`Hello, I would like to buy: ${productName}`);
                whatsappLink.href = `https://wa.me/94767854069?text=${whatsappMessage}`;
                discordLink.href = 'https://discord.gg/nsz5SFhXMh';
            }

            modal.classList.remove('hidden');
        }

        /**
         * This function closes the buy now modal.
         */
        function closeModal() {
            const modal = document.getElementById('buyNowModal');
            modal.classList.add('hidden');
        }

    function scrollToProducts() {
        const productsSection = document.querySelector('.mb-12');
        if (productsSection) {
            productsSection.scrollIntoView({ behavior: 'smooth' });
        }
        }

    // Retry mechanism with exponential backoff
    async function retryFirebaseCall(apiCall, maxRetries = 3, baseDelay = 1000) {
        for (let attempt = 0; attempt < maxRetries; attempt++) {
            try {
                return await apiCall();
            } catch (error) {
                if (attempt === maxRetries - 1) {
                    throw error;
                }
                
                const delay = baseDelay * Math.pow(2, attempt);
                console.log(`Firebase call failed, retrying in ${delay}ms (attempt ${attempt + 1}/${maxRetries})`);
                await new Promise(resolve => setTimeout(resolve, delay));
            }
        }
    }
    
    // Safe Firebase call wrapper
    async function safeFirebaseCall(apiCall, fallback) {
        try {
            return await retryFirebaseCall(apiCall);
        } catch (error) {
            console.warn('Firebase call failed, using fallback:', error);
            return fallback();
        }
    }

    </script>
    <script src="widgets\testimonials.js"></script>
    <script src="widgets\chat-widget.js"></script>

</body>
</html>
